<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim AI Sohbet AsistanÄ±</title>
    <!-- Tailwind CSS YÃ¼klemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        /* Sohbet geÃ§miÅŸi animasyonu */
        .chat-message {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">
    
    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-4 sm:p-8 space-y-6">
        <header class="border-b pb-4 mb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">ğŸ¤– Anonim AI AsistanÄ±</h1>
            <p id="auth-status" class="mt-1 text-sm text-gray-600">Oturum durumu yÃ¼kleniyor...</p>
            <div id="api-warning" class="mt-2 text-sm p-2 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
                âš ï¸ **UYARI:** **Gemini API Key** ayarlanmamÄ±ÅŸ veya hatalÄ±. AI Ã§aÄŸrÄ±larÄ± Ã§alÄ±ÅŸmayacaktÄ±r.
            </div>
            <div id="firebase-warning" class="mt-2 text-sm p-2 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
                âš ï¸ **UYARI:** **Firebase GiriÅŸ HatasÄ±**. LÃ¼tfen konsolu kontrol edin veya anahtarlarÄ± doÄŸrulayÄ±n. Sohbet kilitli olabilir.
            </div>
        </header>

        <!-- Ana Konteyner -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sol Panel: Sadece Ayarlar (Auth gizlendi) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- SÄ°STEM TALÄ°MATI BÃ–LÃœMÃœ -->
                <div class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700">âš™ï¸ AI TalimatÄ± (Anonim)</h2>
                    <textarea id="instruction-textarea" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm disabled:bg-gray-100" 
                        placeholder="AI'Ä±n nasÄ±l davranmasÄ± gerektiÄŸini buraya yazÄ±n. (Ã–rn: KÄ±sa ve mizahi cevaplar ver.)" disabled></textarea>
                    <button id="instruction-update-btn" class="w-full px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition duration-150 disabled:bg-purple-300" disabled>TalimatÄ± GÃ¼ncelle & Kaydet</button>
                    <p id="instruction-status" class="text-sm text-center text-gray-500">Anonim kullanÄ±cÄ±lar talimatÄ± sadece geÃ§ici olarak ayarlar.</p>
                </div>

            </div>

            <!-- SaÄŸ Panel: Sohbet ArayÃ¼zÃ¼ -->
            <div class="lg:col-span-3 space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ’¬ Sohbetiniz</h2>
                
                <!-- Sohbet Kutusu -->
                <div id="chat-history" class="h-[450px] border border-gray-300 rounded-lg p-4 bg-gray-50 overflow-y-auto custom-scrollbar space-y-4">
                    <!-- Mesajlar buraya eklenecek -->
                    <div class="flex justify-center items-center h-full">
                        <span class="text-gray-500">Anonim oturum baÅŸlatÄ±lÄ±yor...</span>
                    </div>
                </div>

                <!-- GiriÅŸ AlanÄ± ve DÃ¼ÄŸme -->
                <div class="flex space-x-3">
                    <input type="text" id="user-input" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled>
                    <button id="send-btn" class="px-6 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>GÃ¶nder</button>
                </div>
                
                <div class="flex justify-between items-center text-sm">
                    <button id="clear-chat-btn" class="text-red-500 hover:text-red-700 transition duration-150">Sohbeti Temizle (GeÃ§ici HafÄ±za)</button>
                    <span id="loading-indicator" class="text-blue-500 hidden">YÃ¼kleniyor...</span>
                </div>
            </div>

        </div>

        <!-- Ã–zel Modal AlanÄ± (Alert yerine) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">BaÅŸlÄ±k</h3>
                <p id="modal-content" class="text-gray-700 mb-4"></p>
                <button id="modal-close-btn" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">Tamam</button>
            </div>
        </div>

    </div>

    <!-- Firebase KÃ¼tÃ¼phaneleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global DeÄŸiÅŸkenler
        let auth;
        let currentUserId = null;
        let chatHistory = []; // Anonim kullanÄ±cÄ±lar iÃ§in geÃ§ici sohbet geÃ§miÅŸi
        const DEFAULT_SYSTEM_INSTRUCTION = "Sen yardÄ±mcÄ± ve kibar bir yapay zeka asistanÄ±sÄ±n. TÃ¼rkÃ§e olarak yanÄ±t ver. YanÄ±tlarÄ±nÄ± kibar ve samimi bir tonda tut.";
        
        // =========================================================================
        // ZORUNLU YAPILANDIRMA (KULLANICI TARAFINDAN SAÄLANDI)
        // =========================================================================
        
        // 1. GEMINI API KEY (KullanÄ±cÄ± tarafÄ±ndan saÄŸlanan deÄŸer)
        const GEMINI_API_KEY = "AIzaSyBdeqvxeHy_SrZYms2xxjUyohU8qPkg0u0"; 

        // 2. FIREBASE CONFIG (KullanÄ±cÄ± tarafÄ±ndan saÄŸlanan gÃ¶rselden alÄ±ndÄ±)
        const firebaseConfig = {
            apiKey: "AIzaSyBmtVU_ceKdSXfjVmrUPYeH1L9pDw5vdc", // <<< Firebase Web API Key
            authDomain: "digit-ai-lab.firebaseapp.com",
            projectId: "digit-ai-lab", // <<< Project ID
            storageBucket: "digit-ai-lab.appspot.com",
            messagingSenderId: "SENDER_ID_HERE", // VarsayÄ±lan deÄŸer
            appId: "APP_ID_HERE" // VarsayÄ±lan deÄŸer
        };
        
        // =========================================================================
        // YARDIMCI FONKSÄ°YONLAR
        // =========================================================================

        /**
         * Custom Modal (Alert yerine)
         * @param {string} title 
         * @param {string} content 
         */
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
        });

        /**
         * Gemini API formatÄ±nÄ± HTML formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         * @param {Array<Object>} history 
         */
        function renderChatHistory(history) {
            const chatDiv = document.getElementById('chat-history');
            chatDiv.innerHTML = ''; // Ã–nceki iÃ§eriÄŸi temizle

            if (history.length === 0) {
                chatDiv.innerHTML = '<div class="flex justify-center items-center h-full"><span class="text-gray-500">Anonim oturum baÅŸlatÄ±ldÄ±. Ä°lk mesajÄ±nÄ±zÄ± yazÄ±n!</span></div>';
                return;
            }

            history.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                let text = msg.parts[0].text;
                
                // Markdown'Ä± temel HTML'e Ã§evir (basit bir yaklaÅŸÄ±m)
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // KalÄ±n
                           .replace(/\n/g, '<br>'); // Yeni satÄ±rlar

                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} chat-message" style="animation-delay: ${index * 0.05}s;">
                        <div class="max-w-xl p-3 rounded-xl shadow-md ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}">
                            <p class="font-bold text-xs mb-1">${isUser ? 'Siz' : 'AI AsistanÄ±'}</p>
                            <p>${text}</p>
                        </div>
                    </div>
                `;

                chatDiv.insertAdjacentHTML('beforeend', messageHtml);
            });


            // En alta kaydÄ±r
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        /**
         * UI elemanlarÄ±nÄ±n aktif/pasif durumunu gÃ¼nceller
         * @param {boolean} isReady - ArayÃ¼zÃ¼n aktif olup olmayacaÄŸÄ±nÄ± belirtir (Auth baÅŸarÄ±lÄ±ysa true)
         */
        function updateUIVisibility(isReady = false) {
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const instructionTextarea = document.getElementById('instruction-textarea');
            const instructionUpdateBtn = document.getElementById('instruction-update-btn');
            const apiWarning = document.getElementById('api-warning');
            
            // API AnahtarÄ± KontrolÃ¼ (Hata DÃ¼zeltme)
            // EÄŸer anahtar boÅŸsa veya varsayÄ±lan bir placeholder ise uyarÄ± gÃ¶ster ve kitle.
            const isApiKeyValid = GEMINI_API_KEY && GEMINI_API_KEY.length > 10 && GEMINI_API_KEY !== "AIzaSyBdeqvxeHy_SrZYms2xxjUyohU8qPkg0u0";
            
            if (!isApiKeyValid) {
                apiWarning.classList.remove('hidden');
                isReady = false; // API anahtarÄ± yoksa hazÄ±r deÄŸil
            } else {
                apiWarning.classList.add('hidden');
            }

            // UI'Ä± sadece hazÄ±r ve API anahtarÄ± geÃ§erliyse aktif et
            userInput.disabled = !isReady;
            sendBtn.disabled = !isReady;
            instructionTextarea.disabled = !isReady;
            instructionUpdateBtn.disabled = !isReady;

            if (!isReady) {
                userInput.placeholder = "GiriÅŸ yapÄ±lÄ±yor veya API AnahtarÄ± bekleniyor...";
            } else {
                userInput.placeholder = "MesajÄ±nÄ±zÄ± buraya yazÄ±n...";
            }
        }


        // =========================================================================
        // FIREBASE Ä°ÅLEMLERÄ° (SADECE ANONÄ°M GÄ°RÄ°Å Ä°Ã‡Ä°N)
        // =========================================================================

        /**
         * Firebase'i baÅŸlatÄ±r ve anonim kimlik doÄŸrulamasÄ±nÄ± yapar.
         */
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // Kimlik doÄŸrulama durumundaki deÄŸiÅŸiklikleri izle
                onAuthStateChanged(auth, async (user) => {
                    const statusText = document.getElementById('auth-status');
                    
                    if (user) {
                        currentUserId = user.uid;
                        statusText.innerHTML = `âœ… **Anonim GiriÅŸ BaÅŸarÄ±lÄ±.** KullanÄ±cÄ±: ANONYMOUS | UID: \`${user.uid.substring(0, 8)}...\``;
                        document.getElementById('instruction-textarea').value = DEFAULT_SYSTEM_INSTRUCTION;
                        
                        // Auth baÅŸarÄ±lÄ±, UI'Ä± aktif etme Ã§aÄŸrÄ±sÄ±
                        updateUIVisibility(true); 
                        
                        renderChatHistory(chatHistory); // BaÅŸlangÄ±Ã§ mesajÄ±nÄ± gÃ¶ster
                    } else {
                        // KullanÄ±cÄ± yoksa anonim giriÅŸ yap
                        statusText.textContent = "Anonim olarak giriÅŸ yapÄ±lÄ±yor...";
                        
                        if (typeof __initial_auth_token !== 'undefined') {
                             // Canvas ortamÄ±nda otomatik giriÅŸ
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // Token yoksa anonim giriÅŸ yap
                            signInAnonymously(auth).catch(error => {
                                console.error("Anonim GiriÅŸ HatasÄ±:", error);
                                document.getElementById('auth-status').innerHTML = `<span class="text-red-600 font-bold">âŒ GÄ°RÄ°Å HATASI: ${error.message}</span>`;
                                document.getElementById('firebase-warning').classList.remove('hidden');
                                updateUIVisibility(false); 
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase baÅŸlatÄ±lÄ±rken hata:", error);
                document.getElementById('auth-status').textContent = `Firebase BaÅŸlatma HatasÄ±: ${error.message}`;
                document.getElementById('firebase-warning').classList.remove('hidden');
                updateUIVisibility(false); 
            }
        }
        
        // =========================================================================
        // SOHBET Ä°ÅLEMLERÄ° VE GEMINI API
        // =========================================================================
        
        // Talimat gÃ¼ncelleme artÄ±k sadece yerel olarak Ã§alÄ±ÅŸacak (sayfa yenilenince sÄ±fÄ±rlanÄ±r)
        document.getElementById('instruction-update-btn').addEventListener('click', async () => {
            const instruction = document.getElementById('instruction-textarea').value.trim();
            if (instruction) {
                document.getElementById('instruction-status').textContent = "âœ… Talimat yerel olarak gÃ¼ncellendi. (Sayfa yenilenince sÄ±fÄ±rlanÄ±r)";
            } else {
                 document.getElementById('instruction-status').textContent = "âš ï¸ Talimat boÅŸ bÄ±rakÄ±lamaz.";
            }
        });

        // Sohbeti Temizle dÃ¼ÄŸmesi artÄ±k sadece yerel chatHistory'i sÄ±fÄ±rlar
        document.getElementById('clear-chat-btn').addEventListener('click', async () => {
            chatHistory = [];
            renderChatHistory(chatHistory);
            showModal("BaÅŸarÄ±lÄ±", "Sohbet geÃ§miÅŸi (geÃ§ici hafÄ±za) baÅŸarÄ±yla temizlendi.");
        });
        
        /**
         * Retry mekanizmalÄ± fetch
         */
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("TÃ¼m yeniden denemeler baÅŸarÄ±sÄ±z oldu.");
        }


        /**
         * Gemini API Ã§aÄŸrÄ±sÄ±nÄ± gerÃ§ekleÅŸtirir.
         * @param {string} message 
         */
        async function callGemini(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            
            // UI kitle
            loadingIndicator.classList.remove('hidden');
            // KullanÄ±cÄ±nÄ±n UI'Ä± kilitlenmiÅŸ gibi gÃ¶rmesini engellemek iÃ§in, sadece input'u kitle
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-btn').disabled = true;

            // Yeni kullanÄ±cÄ± mesajÄ±nÄ± geÃ§ici geÃ§miÅŸe ekle ve hemen render et
            chatHistory.push({ role: "user", parts: [{ text: message }] });
            renderChatHistory(chatHistory);

            const systemInstruction = document.getElementById('instruction-textarea').value.trim() || DEFAULT_SYSTEM_INSTRUCTION;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            // Sohbet geÃ§miÅŸini API'ye uygun hale getir
            const contentsPayload = chatHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: msg.parts
            }));

            const payload = {
                contents: contentsPayload, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            const headers = { "Content-Type": "application/json" };
            
            try {
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // API hata mesajÄ±nÄ± detaylÄ± gÃ¶stermeye Ã§alÄ±ÅŸ
                    const errorJson = await response.json();
                    throw new Error(`API hatasÄ±: ${response.status}. Detay: ${errorJson.error?.message || response.statusText}`);
                }

                const result = await response.json();
                const candidate = result?.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let responseText = candidate.content.parts[0].text;
                    
                    let sources = "";
                    const grounding = candidate.groundingMetadata?.groundingAttributions;
                    if (grounding && grounding.length > 0) {
                        sources = "<br><br><span class='font-semibold'>Kaynaklar:</span><br>";
                        grounding.forEach((attr, index) => {
                            const uri = attr.web?.uri || '#';
                            const title = attr.web?.title || 'Bilinmeyen BaÅŸlÄ±k';
                            // KaynaklarÄ± listele ve baÄŸlantÄ± ver
                            sources += `${index + 1}. <a href="${uri}" target="_blank" class="text-xs text-blue-300 hover:text-blue-100">${title}</a><br>`;
                        });
                        responseText += sources;
                    }

                    // AI yanÄ±tÄ±nÄ± geÃ§ici geÃ§miÅŸe ekle
                    chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                    
                    // Yeni geÃ§miÅŸi render et
                    renderChatHistory(chatHistory);

                } else {
                    // YanÄ±t yoksa veya engellenmiÅŸse
                    let reason = candidate?.finishReason || "Bilinmiyor";
                    let safety = candidate?.safetyRatings?.[0]?.probability || "Yok";
                    
                    chatHistory.push({ role: "model", parts: [{ text: `YanÄ±t alÄ±namadÄ±. BitiÅŸ Nedeni: ${reason}. GÃ¼venlik Ä°hlali: ${safety}` }] });
                    renderChatHistory(chatHistory);
                }

            } catch (error) {
                console.error("Gemini API Ã‡aÄŸrÄ±sÄ± BaÅŸarÄ±sÄ±z:", error);
                
                // Hata mesajÄ±nÄ± sohbete ekle
                chatHistory.push({ role: "model", parts: [{ text: `Sunucu veya API hatasÄ± oluÅŸtu: ${error.message}` }] });
                renderChatHistory(chatHistory);

                showModal("API HatasÄ±", "AI asistanÄ±ndan yanÄ±t alÄ±namadÄ±. Konsolu kontrol edin veya API anahtarÄ±nÄ±zÄ±n doÄŸru olduÄŸundan emin olun.");
            } finally {
                // UI kilidini kaldÄ±r ve temizle
                loadingIndicator.classList.add('hidden');
                // Sadece input'larÄ± geri aÃ§
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            }
        }

        document.getElementById('send-btn').addEventListener('click', () => {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (message) {
                callGemini(message);
                input.value = ''; // GiriÅŸ alanÄ±nÄ± temizle
            }
        });

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-btn').click();
            }
        });

        // Uygulama yÃ¼klendiÄŸinde Firebase'i baÅŸlat
        window.onload = initFirebase;

    </script>
</body>
</html>
