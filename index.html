<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim ve Ãœyeli Sohbet UygulamasÄ±</title>
    <!-- Tailwind CSS YÃ¼klemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-message {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">
    
    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 sm:p-8 space-y-6">
        <header class="border-b pb-4 mb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                AI Sohbet AsistanÄ±
            </h1>
            <div class="flex space-x-3 items-center">
                <div id="countdown-timer" class="text-lg font-bold text-red-600 hidden"></div>
                <button id="auth-modal-open-btn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150 hidden">
                    GiriÅŸ Yap / KayÄ±t Ol
                </button>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 hidden">
                    Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </header>

        <p id="auth-status" class="mt-1 text-sm text-gray-600">Oturum durumu yÃ¼kleniyor...</p>
        
        <!-- Ana Ä°Ã§erik -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sol Panel: Sadece Ayarlar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- SÄ°STEM TALÄ°MATI BÃ–LÃœMÃœ -->
                <div class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                    <h2 class="text-xl font-semibold text-gray-700">âš™ï¸ AI TalimatÄ±</h2>
                    <textarea id="instruction-textarea" rows="4" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 disabled:bg-gray-200" 
                        placeholder="AI'Ä±n nasÄ±l davranmasÄ± gerektiÄŸini buraya yazÄ±n." disabled></textarea>
                    <button id="instruction-update-btn" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition disabled:bg-blue-300" disabled>TalimatÄ± Kaydet</button>
                    <p id="instruction-status" class="text-sm text-center text-gray-500">Anonim kullanÄ±cÄ±lar talimatÄ± kaydedemez.</p>
                </div>
                
                <!-- Hata/UyarÄ± AlanÄ± -->
                <div id="alert-container" class="space-y-2">
                    <div id="api-warning" class="text-sm p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
                        âš ï¸ **UYARI:** **Gemini API Key** ayarlanmamÄ±ÅŸ. Sohbet Ã§alÄ±ÅŸmayacaktÄ±r.
                    </div>
                    <div id="firebase-warning" class="text-sm p-3 bg-yellow-100 text-yellow-700 border border-yellow-300 rounded-lg hidden">
                        âš ï¸ **HATA:** **Firebase YapÄ±landÄ±rmasÄ±** eksik veya hatalÄ±.
                    </div>
                </div>

            </div>

            <!-- SaÄŸ Panel: Sohbet ArayÃ¼zÃ¼ -->
            <div class="lg:col-span-3 space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ’¬ Sohbetiniz</h2>
                
                <!-- Sohbet Kutusu -->
                <div id="chat-history" class="h-[450px] border border-gray-300 rounded-lg p-4 bg-white overflow-y-auto custom-scrollbar space-y-4 shadow-inner">
                    <div class="flex justify-center items-center h-full">
                        <span class="text-gray-500">Anonim giriÅŸ bekleniyor...</span>
                    </div>
                </div>

                <!-- GiriÅŸ AlanÄ± ve DÃ¼ÄŸme -->
                <div class="flex space-x-3">
                    <input type="text" id="user-input" placeholder="LÃ¼tfen oturum aÃ§Ä±lmasÄ±nÄ± bekleyin..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 disabled:bg-gray-100" disabled>
                    <button id="send-btn" class="px-6 py-3 text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition duration-150 disabled:bg-purple-300" disabled>GÃ¶nder</button>
                </div>
                
                <div class="flex justify-between items-center text-sm">
                    <button id="clear-chat-btn" class="text-red-500 hover:text-red-700 transition duration-150" disabled>Sohbeti Temizle (VeritabanÄ± dahil)</button>
                    <span id="loading-indicator" class="text-blue-500 hidden font-medium">AI yanÄ±tÄ± bekleniyor...</span>
                </div>
            </div>

        </div>

        <!-- Ã–zel Modal AlanÄ± (Alert yerine) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">BaÅŸlÄ±k</h3>
                <p id="modal-content" class="text-gray-700 mb-4"></p>
                <button id="modal-close-btn" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">Tamam</button>
            </div>
        </div>

        <!-- GÄ°RÄ°Å/KAYIT MODALI -->
        <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100">
                <div class="flex justify-between items-center mb-6 border-b pb-3">
                    <h3 id="auth-modal-title" class="text-2xl font-bold text-gray-800">Oturum YÃ¶netimi</h3>
                    <button id="auth-modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                
                <div class="flex mb-4">
                    <button id="modal-login-tab" class="flex-1 p-3 text-center font-semibold rounded-l-lg border border-r-0 border-blue-500 bg-blue-500 text-white">GiriÅŸ Yap</button>
                    <button id="modal-register-tab" class="flex-1 p-3 text-center font-semibold rounded-r-lg border border-blue-500 bg-gray-100 text-blue-600 hover:bg-gray-200">KayÄ±t Ol</button>
                </div>

                <!-- GiriÅŸ Formu -->
                <div id="login-form-content" class="space-y-4">
                    <input type="email" id="login-email" placeholder="E-posta Adresi" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 text-base">
                    <input type="password" id="login-password" placeholder="Åifre" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 text-base">
                    <button id="modal-login-btn" class="w-full px-4 py-3 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition text-lg font-bold">GiriÅŸ Yap</button>
                    <p id="login-error-message" class="text-sm text-red-500 text-center hidden"></p>
                </div>

                <!-- KayÄ±t Formu -->
                <div id="register-form-content" class="space-y-4 hidden">
                    <input type="email" id="register-email" placeholder="E-posta Adresi" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 text-base">
                    <input type="password" id="register-password" placeholder="Åifre (Min 6 Karakter)" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 text-base">
                    <input type="password" id="register-password-confirm" placeholder="Åifre OnayÄ±" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 text-base">
                    <button id="modal-register-btn" class="w-full px-4 py-3 text-white bg-purple-600 rounded-lg shadow-md hover:bg-purple-700 transition text-lg font-bold">KayÄ±t Ol</button>
                    <p id="register-error-message" class="text-sm text-red-500 text-center hidden"></p>
                </div>

            </div>
        </div>

    </div>

    <!-- Firebase KÃ¼tÃ¼phaneleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================
        // GLOBAL DEÄÄ°ÅKENLER VE YAPILANDIRMA
        // =========================================================================
        
        let auth, db, app;
        let currentUserId = null;
        let isAnonymous = false;
        let chatHistory = []; 
        let countdownInterval;
        const ANON_TIMEOUT_MS = 5 * 60 * 1000; // 5 dakika
        const COLLECTION_NAME = 'ai_chats';
        const DEFAULT_SYSTEM_INSTRUCTION = "Sen yardÄ±mcÄ± ve kibar bir yapay zeka asistanÄ±sÄ±n. TÃ¼rkÃ§e olarak yanÄ±t ver. YanÄ±tlarÄ±nÄ± kibar ve samimi bir tonda tut.";
        
        // Firebase Config (Ã–nceki gÃ¶rsellerinizden alÄ±nan deÄŸerler, geÃ§erli olmalÄ±)
        const firebaseConfig = {
            apiKey: "AIzaSyBmtVU_ceKdSXfjVmrUPYeH1L9pDw5vdc", // Firebase Web API Key
            authDomain: "digit-ai-lab.firebaseapp.com",
            projectId: "digit-ai-lab",
            storageBucket: "digit-ai-lab.appspot.com",
            messagingSenderId: "SENDER_ID_HERE", 
            appId: "APP_ID_HERE" 
        };

        // Gemini API Key (Sohbet iÃ§in gereklidir)
        const GEMINI_API_KEY = "AIzaSyBdeqvxeHy_SrZYms2xxjUyohU8qPkg0u0"; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // =========================================================================
        // YARDIMCI FONKSÄ°YONLAR (UI & Modal)
        // =========================================================================

        function getChatRef(uid) {
            // Ã–zel/Auth kullanÄ±cÄ±lar iÃ§in: /artifacts/{appId}/users/{userId}/ai_chats/{uid}
            // Anonim kullanÄ±cÄ±lar iÃ§in: /artifacts/{appId}/users/{anonId}/ai_chats/{anonId}
            const path = `/artifacts/${appId}/users/${uid}/${COLLECTION_NAME}`;
            return doc(db, path, uid); 
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').classList.remove('hidden');
        }
        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
        });

        function renderChatHistory(history) {
            const chatDiv = document.getElementById('chat-history');
            chatDiv.innerHTML = ''; 

            if (history.length === 0) {
                chatDiv.innerHTML = '<div class="flex justify-center items-center h-full"><span class="text-gray-500">HoÅŸ geldiniz! Ä°lk mesajÄ±nÄ±zÄ± yazÄ±n.</span></div>';
                return;
            }

            history.forEach((msg, index) => {
                const isUser = msg.role === 'user';
                let text = msg.parts[0].text;
                
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); 

                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} chat-message" style="animation-delay: ${index * 0.05}s;">
                        <div class="max-w-xl p-3 rounded-xl shadow-md ${isUser ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-800'}">
                            <p class="font-bold text-xs mb-1">${isUser ? 'Siz' : 'AI AsistanÄ±'}</p>
                            <p>${text}</p>
                        </div>
                    </div>
                `;
                chatDiv.insertAdjacentHTML('beforeend', messageHtml);
            });
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function updateUIVisibility(isReady = false, isAnon) {
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const instructionTextarea = document.getElementById('instruction-textarea');
            const instructionUpdateBtn = document.getElementById('instruction-update-btn');
            const authModalOpenBtn = document.getElementById('auth-modal-open-btn');
            const logoutBtn = document.getElementById('logout-btn');

            const isApiKeyValid = GEMINI_API_KEY && GEMINI_API_KEY.length > 10;
            const finalReady = isReady && isApiKeyValid;
            
            document.getElementById('api-warning').classList.toggle('hidden', isApiKeyValid);

            userInput.disabled = !finalReady;
            sendBtn.disabled = !finalReady;
            clearChatBtn.disabled = !finalReady;
            instructionTextarea.disabled = !finalReady;
            instructionUpdateBtn.disabled = !(finalReady && !isAnon); // Anonim kullanÄ±cÄ±lar kaydedemez

            if (isAnon) {
                authModalOpenBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                document.getElementById('instruction-status').textContent = "Anonim kullanÄ±cÄ±lar talimatÄ± kaydedemez.";
            } else {
                authModalOpenBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                document.getElementById('instruction-status').textContent = "TalimatÄ±nÄ±z kaydedilebilir.";
            }

            userInput.placeholder = finalReady ? "MesajÄ±nÄ±zÄ± buraya yazÄ±n..." : "Oturum aÃ§ma bekleniyor veya API hatasÄ± var.";
        }

        // =========================================================================
        // FIREBASE & VERÄ°TABANI Ä°ÅLEMLERÄ°
        // =========================================================================

        /**
         * Firestore'dan sohbeti yÃ¼kler ve yerel geÃ§miÅŸi gÃ¼nceller.
         */
        async function loadChatHistory(uid) {
            try {
                const docRef = getChatRef(uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // JSON.parse ile karmaÅŸÄ±k yapÄ±yÄ± geri yÃ¼kle
                    chatHistory = JSON.parse(data.historyJson || '[]');
                    document.getElementById('instruction-textarea').value = data.systemInstruction || DEFAULT_SYSTEM_INSTRUCTION;
                } else {
                    // Yeni kullanÄ±cÄ± veya anonim kullanÄ±cÄ±
                    chatHistory = [];
                    document.getElementById('instruction-textarea').value = DEFAULT_SYSTEM_INSTRUCTION;
                }
                renderChatHistory(chatHistory);
            } catch (error) {
                console.error("Sohbet geÃ§miÅŸi yÃ¼klenirken hata:", error);
                // Hata durumunda bile sohbeti sÄ±fÄ±rdan baÅŸlat
                chatHistory = [];
                document.getElementById('instruction-textarea').value = DEFAULT_SYSTEM_INSTRUCTION;
                renderChatHistory(chatHistory);
                showModal("VeritabanÄ± HatasÄ±", "Sohbet geÃ§miÅŸi yÃ¼klenirken bir sorun oluÅŸtu.");
            }
        }

        /**
         * Sohbeti Firestore'a kaydeder.
         */
        async function saveChatHistory(uid, history, systemInstruction, markForDeletion = false) {
            try {
                const docRef = getChatRef(uid);
                
                const data = {
                    // KarmaÅŸÄ±k yapÄ±yÄ± JSON string olarak kaydet
                    historyJson: JSON.stringify(history), 
                    systemInstruction: systemInstruction,
                    lastUpdated: new Date(),
                    isAnonymous: isAnonymous
                };
                
                if (markForDeletion) {
                    // 48 saat sonra silinmek Ã¼zere iÅŸaretle
                    const deletionTime = new Date(Date.now() + 48 * 60 * 60 * 1000); 
                    data.deleteAfter = deletionTime;
                } else if (isAnonymous) {
                     // Anonim kullanÄ±cÄ± kaydetmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda deleteAfter alanÄ± silinmeli
                    delete data.deleteAfter;
                }

                await setDoc(docRef, data, { merge: true });
                console.log(`Sohbet baÅŸarÄ±yla kaydedildi/gÃ¼ncellendi. UID: ${uid}`);
                return true;

            } catch (error) {
                console.error("Sohbet kaydedilirken hata:", error);
                showModal("Veri KayÄ±t HatasÄ±", `Sohbet geÃ§miÅŸi kaydedilemedi. Hata: ${error.message}`);
                return false;
            }
        }
        
        // =========================================================================
        // ANONÄ°M OTURUM SÃœRESÄ° YÃ–NETÄ°MÄ° (5 Dk)
        // =========================================================================

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const timerDisplay = document.getElementById('countdown-timer');
            timerDisplay.classList.remove('hidden');

            let timeLeft = ANON_TIMEOUT_MS;

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                timerDisplay.textContent = `Anonim Kalan SÃ¼re: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerDisplay.textContent = 'SÃœRE DOLDU! LÃ¼tfen kayÄ±t olun.';
                    updateUIVisibility(false, true); // Sohbeti kitle
                    document.getElementById('auth-modal-open-btn').click(); // Modal'Ä± aÃ§
                }
                
                timeLeft -= 1000;
            }

            updateTimer(); 
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdown-timer').classList.add('hidden');
        }

        // =========================================================================
        // FIREBASE AUTH MANTIKLARI
        // =========================================================================

        async function handleSuccessfulAuth(user) {
            currentUserId = user.uid;
            isAnonymous = user.isAnonymous;
            
            const email = user.email || (user.isAnonymous ? "Anonim KullanÄ±cÄ±" : "E-posta/Token GiriÅŸi");
            const statusText = document.getElementById('auth-status');
            statusText.innerHTML = `âœ… **GiriÅŸ BaÅŸarÄ±lÄ±.** ${user.isAnonymous ? 'Anonim Oturum' : 'Ãœyeli Oturum'} | KullanÄ±cÄ±: <span class="font-bold">${email}</span>`;
            
            await loadChatHistory(currentUserId);
            updateUIVisibility(true, isAnonymous);
            
            if (isAnonymous) {
                startCountdown();
            } else {
                stopCountdown();
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (!auth || !currentUserId) return;
            
            // Ã‡Ä±kÄ±ÅŸ yapmadan Ã¶nce mevcut sohbeti yedekle
            await saveChatHistory(currentUserId, chatHistory, document.getElementById('instruction-textarea').value.trim());

            try {
                await signOut(auth);
                showModal("BaÅŸarÄ±lÄ±", "BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z. Sohbetiniz kaydedildi.");
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ HatasÄ±:", error);
                showModal("Hata", `Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu: ${error.message}`);
            }
        });

        // =========================================================================
        // MODAL VE FORM Ä°ÅLEMLERÄ° (GiriÅŸ/KayÄ±t)
        // =========================================================================

        // Modal Kapatma
        document.getElementById('auth-modal-close-btn').addEventListener('click', () => {
            document.getElementById('auth-modal').classList.add('hidden');
        });
        // Modal AÃ§ma
        document.getElementById('auth-modal-open-btn').addEventListener('click', () => {
            document.getElementById('auth-modal').classList.remove('hidden');
        });

        // Tab DeÄŸiÅŸtirme
        document.getElementById('modal-login-tab').addEventListener('click', () => {
            document.getElementById('login-form-content').classList.remove('hidden');
            document.getElementById('register-form-content').classList.add('hidden');
            document.getElementById('modal-login-tab').classList.replace('bg-gray-100', 'bg-blue-500');
            document.getElementById('modal-login-tab').classList.replace('text-blue-600', 'text-white');
            document.getElementById('modal-register-tab').classList.replace('bg-purple-500', 'bg-gray-100');
            document.getElementById('modal-register-tab').classList.replace('text-white', 'text-blue-600');
            document.getElementById('auth-modal-title').textContent = "GiriÅŸ Yap";
        });
        document.getElementById('modal-register-tab').addEventListener('click', () => {
            document.getElementById('login-form-content').classList.add('hidden');
            document.getElementById('register-form-content').classList.remove('hidden');
            document.getElementById('modal-register-tab').classList.replace('bg-gray-100', 'bg-purple-500');
            document.getElementById('modal-register-tab').classList.replace('text-blue-600', 'text-white');
            document.getElementById('modal-login-tab').classList.replace('bg-blue-500', 'bg-gray-100');
            document.getElementById('modal-login-tab').classList.replace('text-white', 'text-blue-600');
            document.getElementById('auth-modal-title').textContent = "KayÄ±t Ol";
        });

        // GiriÅŸ Butonu Ä°ÅŸlemi
        document.getElementById('modal-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error-message');
            errorMsg.classList.add('hidden');

            if (!email || password.length < 6) {
                errorMsg.textContent = "LÃ¼tfen geÃ§erli bir e-posta ve en az 6 karakterli ÅŸifre girin.";
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-modal').classList.add('hidden');
                showModal("BaÅŸarÄ±lÄ±", "GiriÅŸ yapÄ±ldÄ±! Sohbet geÃ§miÅŸiniz yÃ¼klendi.");
                // onAuthStateChanged tetiklenecek ve yeni kullanÄ±cÄ±yÄ± handle edecek
            } catch (error) {
                console.error("GiriÅŸ HatasÄ±:", error);
                errorMsg.textContent = `GiriÅŸ HatasÄ±: ${error.message}`;
                errorMsg.classList.remove('hidden');
            }
        });

        // KayÄ±t Butonu Ä°ÅŸlemi
        document.getElementById('modal-register-btn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const errorMsg = document.getElementById('register-error-message');
            errorMsg.classList.add('hidden');

            if (password !== passwordConfirm) {
                errorMsg.textContent = "HatalÄ± ÅŸifreler! Åifreleriniz eÅŸleÅŸmiyor.";
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!email || password.length < 6) {
                errorMsg.textContent = "LÃ¼tfen geÃ§erli bir e-posta ve en az 6 karakterli ÅŸifre girin.";
                errorMsg.classList.remove('hidden');
                return;
            }

            // KayÄ±t olmadan Ã¶nceki anonim geÃ§miÅŸi yedekle
            const anonUserId = currentUserId; 
            const anonHistory = [...chatHistory]; 
            const anonInstruction = document.getElementById('instruction-textarea').value.trim();

            try {
                // Yeni kullanÄ±cÄ± oluÅŸtur (onAuthStateChanged tetiklenecek)
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Anonim sohbeti yeni kullanÄ±cÄ±ya yedekle (TRANSACTION kullanarak)
                await runTransaction(db, async (transaction) => {
                    const newChatRef = getChatRef(userCredential.user.uid);
                    
                    transaction.set(newChatRef, {
                        historyJson: JSON.stringify(anonHistory), 
                        systemInstruction: anonInstruction,
                        lastUpdated: new Date(),
                        isAnonymous: false,
                        mergedFromAnonId: anonUserId // Hangi anonim ID'den geldiÄŸini kaydet
                    }, { merge: true });

                    // Eski anonim kaydÄ± silinmek Ã¼zere iÅŸaretle
                    const oldAnonRef = getChatRef(anonUserId);
                    const deletionTime = new Date(Date.now() + 48 * 60 * 60 * 1000); 
                    transaction.update(oldAnonRef, { 
                        deleteAfter: deletionTime,
                        isMerged: true
                    });
                });

                document.getElementById('auth-modal').classList.add('hidden');
                showModal("BaÅŸarÄ±lÄ±", "KayÄ±t baÅŸarÄ±lÄ±! Anonim sohbetiniz hesabÄ±nÄ±za yedeklendi.");
            } catch (error) {
                console.error("KayÄ±t HatasÄ±:", error);
                errorMsg.textContent = `KayÄ±t HatasÄ±: ${error.message}`;
                errorMsg.classList.remove('hidden');
            }
        });
        
        // =========================================================================
        // SOHBET Ä°ÅLEMLERÄ°
        // =========================================================================

        document.getElementById('instruction-update-btn').addEventListener('click', async () => {
            const instruction = document.getElementById('instruction-textarea').value.trim();
            if (isAnonymous) {
                document.getElementById('instruction-status').textContent = "Anonim kullanÄ±cÄ±lar talimatÄ± kaydedemez. Sadece yerel olarak kullanÄ±ldÄ±.";
                return;
            }
            if (instruction) {
                const success = await saveChatHistory(currentUserId, chatHistory, instruction);
                if(success) {
                    document.getElementById('instruction-status').textContent = "âœ… Talimat veritabanÄ±na kaydedildi.";
                }
            } else {
                 document.getElementById('instruction-status').textContent = "âš ï¸ Talimat boÅŸ bÄ±rakÄ±lamaz.";
            }
        });

        document.getElementById('clear-chat-btn').addEventListener('click', async () => {
            if (!currentUserId) return;
            
            chatHistory = [];
            renderChatHistory(chatHistory);
            
            // VeritabanÄ±ndan da sil
            try {
                const docRef = getChatRef(currentUserId);
                await deleteDoc(docRef);
                showModal("BaÅŸarÄ±lÄ±", "Sohbet geÃ§miÅŸi hem yerel hem de veritabanÄ±ndan temizlendi.");
            } catch (error) {
                console.error("Sohbet silinirken hata:", error);
                showModal("Hata", "Sohbet geÃ§miÅŸi veritabanÄ±ndan silinirken bir hata oluÅŸtu.");
            }
        });
        
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("TÃ¼m yeniden denemeler baÅŸarÄ±sÄ±z oldu.");
        }


        async function callGemini(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-btn').disabled = true;

            chatHistory.push({ role: "user", parts: [{ text: message }] });
            renderChatHistory(chatHistory);

            const systemInstruction = document.getElementById('instruction-textarea').value.trim() || DEFAULT_SYSTEM_INSTRUCTION;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const contentsPayload = chatHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: msg.parts
            }));

            const payload = {
                contents: contentsPayload, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            try {
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`API hatasÄ±: ${response.status}. Detay: ${errorJson.error?.message || response.statusText}`);
                }

                const result = await response.json();
                const candidate = result?.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let responseText = candidate.content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                    renderChatHistory(chatHistory);
                    
                    // Her baÅŸarÄ±lÄ± yanÄ±ttan sonra sohbeti kaydet
                    await saveChatHistory(currentUserId, chatHistory, systemInstruction, isAnonymous && chatHistory.length > 0); 
                } else {
                    let reason = candidate?.finishReason || "Bilinmiyor";
                    chatHistory.push({ role: "model", parts: [{ text: `YanÄ±t alÄ±namadÄ±. BitiÅŸ Nedeni: ${reason}.` }] });
                    renderChatHistory(chatHistory);
                }

            } catch (error) {
                console.error("Gemini API Ã‡aÄŸrÄ±sÄ± BaÅŸarÄ±sÄ±z:", error);
                chatHistory.push({ role: "model", parts: [{ text: `Sunucu veya API hatasÄ± oluÅŸtu: ${error.message}` }] });
                renderChatHistory(chatHistory);
                showModal("API HatasÄ±", "AI asistanÄ±ndan yanÄ±t alÄ±namadÄ±. Konsolu kontrol edin.");
            } finally {
                loadingIndicator.classList.add('hidden');
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('user-input').focus();
            }
        }

        document.getElementById('send-btn').addEventListener('click', () => {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (message) {
                callGemini(message);
                input.value = ''; 
            }
        });

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-btn').click();
            }
        });


        // =========================================================================
        // UYGULAMA BAÅLANGICI
        // =========================================================================
        
        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // KullanÄ±cÄ± GiriÅŸ YapmÄ±ÅŸ/Token ile gelmiÅŸ/Anonim
                        await handleSuccessfulAuth(user);
                    } else {
                        // KullanÄ±cÄ± yoksa (Token veya Anonim giriÅŸ)
                        updateUIVisibility(false, true); 
                        stopCountdown(); // Timer sÄ±fÄ±rla

                        if (typeof __initial_auth_token !== 'undefined') {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            signInAnonymously(auth).catch(error => {
                                console.error("Anonim GiriÅŸ HatasÄ±:", error);
                                document.getElementById('firebase-warning').classList.remove('hidden');
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase baÅŸlatÄ±lÄ±rken hata:", error);
                document.getElementById('firebase-warning').classList.remove('hidden');
                updateUIVisibility(false, true); 
            }
        }
        
        window.onload = initFirebase;
    </script>
</body>
</html>
