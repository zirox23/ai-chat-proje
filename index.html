<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Statik Ã‡oklu KullanÄ±cÄ± Sohbeti</title>
    <!-- Tailwind CSS YÃ¼klemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* KaydÄ±rma Ã§ubuÄŸunu gÃ¼zelleÅŸtirme */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">
    
    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-4 sm:p-8 space-y-6">
        <header class="border-b pb-4 mb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">ğŸ‡¹ğŸ‡· GitHub Pages AI AsistanÄ±</h1>
            <p id="auth-status" class="mt-1 text-sm text-gray-600">Oturum durumu yÃ¼kleniyor...</p>
            <div id="api-warning" class="mt-2 text-sm p-2 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden">
                âš ï¸ **UYARI:** `GEMINI_API_KEY` deÄŸiÅŸkeni ayarlanmamÄ±ÅŸ. API Ã§aÄŸrÄ±larÄ± Ã§alÄ±ÅŸmayacaktÄ±r.
            </div>
        </header>

        <!-- Ana Konteyner -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sol Panel: Kimlik DoÄŸrulama ve Ayarlar -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- GÄ°RÄ°Å / KAYIT BÃ–LÃœMÃœ -->
                <div id="auth-section" class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700">ğŸ”’ GiriÅŸ / KayÄ±t (SimÃ¼lasyon)</h2>
                    <p class="text-xs text-gray-500">Roller: `admin@example.com` (YÃ¶netici), `mod@example.com` (ModeratÃ¶r).</p>
                    <input type="email" id="email-input" placeholder="E-posta" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="password" id="password-input" placeholder="Åifre" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <div class="flex space-x-2">
                        <button id="login-btn" class="w-1/2 px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">GiriÅŸ Yap</button>
                        <button id="register-btn" class="w-1/2 px-4 py-2 text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 transition duration-150">KayÄ±t Ol</button>
                    </div>
                    <p id="auth-message" class="text-sm text-center text-red-500"></p>
                </div>

                <!-- Ã‡IKIÅ BÃ–LÃœMÃœ -->
                <div id="logout-section" class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm hidden">
                    <h2 class="text-xl font-semibold text-gray-700">Oturumunuz</h2>
                    <p id="user-info" class="text-sm font-medium text-gray-600"></p>
                    <button id="logout-btn" class="w-full px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>

                <!-- SÄ°STEM TALÄ°MATI BÃ–LÃœMÃœ -->
                <div class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700">âš™ï¸ AI TalimatÄ±</h2>
                    <textarea id="instruction-textarea" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm" 
                        placeholder="AI'Ä±n nasÄ±l davranmasÄ± gerektiÄŸini buraya yazÄ±n."></textarea>
                    <button id="instruction-update-btn" class="w-full px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition duration-150">TalimatÄ± GÃ¼ncelle & Kaydet</button>
                    <p id="instruction-status" class="text-sm text-center text-gray-500"></p>
                </div>

                <!-- Mod/Admin GÃ¶rÃ¼nÃ¼mÃ¼ -->
                <div id="admin-mod-section" class="space-y-3 p-4 border border-gray-200 rounded-lg shadow-sm hidden">
                    <h2 class="text-xl font-semibold text-gray-700">ğŸ‘ï¸ YÃ¶netici GÃ¶rÃ¼nÃ¼mÃ¼</h2>
                    <select id="user-id-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 text-sm">
                        <option value="">-- KullanÄ±cÄ± SeÃ§ --</option>
                    </select>
                    <div id="admin-chat-history" class="h-64 border p-3 rounded-lg bg-gray-50 overflow-y-auto custom-scrollbar text-sm">
                        KullanÄ±cÄ± sohbet geÃ§miÅŸi buraya yÃ¼klenecektir.
                    </div>
                </div>

            </div>

            <!-- SaÄŸ Panel: Sohbet ArayÃ¼zÃ¼ -->
            <div class="lg:col-span-3 space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ’¬ Sohbetiniz</h2>
                
                <!-- Sohbet Kutusu -->
                <div id="chat-history" class="h-[450px] border border-gray-300 rounded-lg p-4 bg-gray-50 overflow-y-auto custom-scrollbar space-y-4">
                    <!-- Mesajlar buraya eklenecek -->
                    <div class="flex justify-center items-center h-full">
                        <span class="text-gray-500">LÃ¼tfen giriÅŸ yapÄ±n veya anonim olarak devam edin.</span>
                    </div>
                </div>

                <!-- GiriÅŸ AlanÄ± ve DÃ¼ÄŸme -->
                <div class="flex space-x-3">
                    <input type="text" id="user-input" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100" disabled>
                    <button id="send-btn" class="px-6 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>GÃ¶nder</button>
                </div>
                
                <div class="flex justify-between items-center text-sm">
                    <button id="clear-chat-btn" class="text-red-500 hover:text-red-700 transition duration-150">Sohbeti Temizle (VeritabanÄ± dahil)</button>
                    <span id="loading-indicator" class="text-blue-500 hidden">YÃ¼kleniyor...</span>
                </div>
            </div>

        </div>

        <!-- Ã–zel Modal AlanÄ± (Alert yerine) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">BaÅŸlÄ±k</h3>
                <p id="modal-content" class="text-gray-700 mb-4"></p>
                <button id="modal-close-btn" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">Tamam</button>
            </div>
        </div>

    </div>

    <!-- Firebase KÃ¼tÃ¼phaneleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global DeÄŸiÅŸkenler
        let db;
        let auth;
        let userRole = "anon";
        let currentUserId = null;
        const DEFAULT_SYSTEM_INSTRUCTION = "Sen yardÄ±mcÄ± ve kibar bir yapay zeka asistanÄ±sÄ±n. TÃ¼rkÃ§e olarak yanÄ±t ver. YanÄ±tlarÄ±nÄ± kibar ve samimi bir tonda tut.";
        const APP_ID = 'github-static-chat-app'; 
        
        // Canvas ortam deÄŸiÅŸkenlerini simÃ¼le etmek iÃ§in (GitHub'da sizin belirlemeniz gerekir)
        const __firebase_config = "{}"; // Bu, Canvas'ta otomatik saÄŸlanÄ±r, GitHub'da manuel ayarlanÄ±r.
        const __initial_auth_token = undefined; // Canvas'ta otomatik saÄŸlanÄ±r. GitHub'da anonim/manuel.
        // GitHub Pages'de API anahtarÄ±nÄ± doÄŸrudan gÃ¶mmek risklidir. Ancak, statik bir sayfa olduÄŸundan baÅŸka seÃ§enek yoktur.
        // PRATÄ°K Ã‡Ã–ZÃœM: KullanÄ±cÄ±dan al, ama burada doÄŸrudan gÃ¶mÃ¼yoruz.
        const GEMINI_API_KEY = "GEMINI_API_KEY_HERE"; // LÃœTFEN BUNU GERÃ‡EK ANAHTARINIZLA DEÄÄ°ÅTÄ°RÄ°N!

        // =========================================================================
        // YARDIMCI FONKSÄ°YONLAR
        // =========================================================================

        /**
         * Custom Modal (Alert yerine)
         * @param {string} title 
         * @param {string} content 
         */
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
        });

        /**
         * Firestore iÃ§in belge yolunu oluÅŸturur (KullanÄ±cÄ±ya Ã¶zel)
         * @param {string} collectionName 
         * @returns {string}
         */
        function getUserDocPath(collectionName) {
            return `artifacts/${APP_ID}/users/${currentUserId}/${collectionName}/data`;
        }

        /**
         * Gemini API formatÄ±nÄ± HTML formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         * @param {Array<Object>} history 
         * @returns {string} HTML iÃ§eriÄŸi
         */
        function renderChatHistory(history) {
            const chatDiv = document.getElementById('chat-history');
            chatDiv.innerHTML = ''; // Ã–nceki iÃ§eriÄŸi temizle

            if (history.length === 0) {
                chatDiv.innerHTML = '<div class="flex justify-center items-center h-full"><span class="text-gray-500">HenÃ¼z sohbet geÃ§miÅŸi yok.</span></div>';
                return;
            }

            for (let i = 0; i < history.length; i += 2) {
                const userMsg = history[i];
                const modelMsg = history[i + 1];

                // KullanÄ±cÄ± MesajÄ±
                if (userMsg && userMsg.role === 'user') {
                    chatDiv.innerHTML += `
                        <div class="flex justify-end">
                            <div class="max-w-xl p-3 rounded-xl bg-blue-500 text-white shadow-md">
                                <p class="font-bold text-xs mb-1">Siz</p>
                                <p>${userMsg.parts[0].text}</p>
                            </div>
                        </div>
                    `;
                }

                // Model MesajÄ±
                if (modelMsg && modelMsg.role === 'model') {
                    // Markdown'Ä± temel HTML'e Ã§evir (basit bir yaklaÅŸÄ±m)
                    let text = modelMsg.parts[0].text
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // KalÄ±n
                                .replace(/\n/g, '<br>'); // Yeni satÄ±rlar

                    chatDiv.innerHTML += `
                        <div class="flex justify-start">
                            <div class="max-w-xl p-3 rounded-xl bg-gray-200 text-gray-800 shadow-md">
                                <p class="font-bold text-xs mb-1">AI AsistanÄ±</p>
                                <p>${text}</p>
                            </div>
                        </div>
                    `;
                }
            }

            // En alta kaydÄ±r
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        /**
         * Firebase formatÄ±nÄ± (kayÄ±tlÄ± mesaj dizisi) Gemini API formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         * @param {Array<Array<string>>} firestoreHistory 
         * @returns {Array<Object>}
         */
        function firestoreToGeminiHistory(firestoreHistory) {
            return firestoreHistory.map(msg => ({
                role: msg[0], // "user" veya "model"
                parts: [{ text: msg[1] }]
            }));
        }

        // =========================================================================
        // FIREBASE Ä°ÅLEMLERÄ°
        // =========================================================================

        /**
         * Firebase'i baÅŸlatÄ±r ve kimlik doÄŸrulama dinleyicisini kurar.
         */
        function initFirebase() {
            try {
                // Firebase Config (LÃœTFEN GERÃ‡EK CONFIG Ä°LE DEÄÄ°ÅTÄ°RÄ°N)
                // Bu config'i Firebase projenizin "Web uygulamasÄ±na" ekleyin.
                const firebaseConfig = {
                    apiKey: "YOUR_FIREBASE_API_KEY", // Ã–rneÄŸin: "AIzaSyC..."
                    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_PROJECT_ID.appspot.com",
                    messagingSenderId: "SENDER_ID",
                    appId: "APP_ID"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Anonim GiriÅŸ veya Token GiriÅŸi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        // KullanÄ±cÄ± rolÃ¼nÃ¼ Firestore'dan yÃ¼kle
                        await loadUserProfile(currentUserId);
                        // Sohbet geÃ§miÅŸini dinlemeye baÅŸla
                        setupChatListener();
                    } else {
                        // Anonim GiriÅŸ
                        const statusText = document.getElementById('auth-status');
                        statusText.textContent = "Anonim olarak giriÅŸ yapÄ±lÄ±yor...";
                        await signInAnonymously(auth);
                        // Anonim kullanÄ±cÄ±lar iÃ§in UID alÄ±nÄ±p, rol "anon" olarak kalacak.
                    }
                });
            } catch (error) {
                console.error("Firebase baÅŸlatÄ±lÄ±rken hata:", error);
                document.getElementById('auth-status').textContent = `Firebase HatasÄ±: ${error.message}`;
            }
        }
        
        /**
         * KullanÄ±cÄ±nÄ±n profilini (Ã¶zellikle rolÃ¼nÃ¼ ve talimatÄ±nÄ±) Firestore'dan yÃ¼kler.
         * @param {string} uid 
         */
        async function loadUserProfile(uid) {
            const profileDocRef = doc(db, `artifacts/${APP_ID}/users/${uid}/profile/data`);
            
            try {
                const docSnap = await getDoc(profileDocRef);
                const statusText = document.getElementById('auth-status');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userRole = data.role || "user";
                    document.getElementById('instruction-textarea').value = data.system_instruction || DEFAULT_SYSTEM_INSTRUCTION;
                    
                    statusText.innerHTML = `âœ… **GiriÅŸ BaÅŸarÄ±lÄ±.** KullanÄ±cÄ±: **${auth.currentUser.email || 'Anonim'}** (${userRole.toUpperCase()}) | UID: \`${uid}\``;
                } else {
                    // Yeni kullanÄ±cÄ± veya anonim kullanÄ±cÄ±
                    userRole = uid.startsWith("anon") ? "anon" : "user";
                    // VarsayÄ±lan profili kaydet
                    await setDoc(profileDocRef, { 
                        role: userRole, 
                        system_instruction: DEFAULT_SYSTEM_INSTRUCTION 
                    }, { merge: true });
                    
                    document.getElementById('instruction-textarea').value = DEFAULT_SYSTEM_INSTRUCTION;
                    statusText.innerHTML = `âœ… **Anonim GiriÅŸ.** Rol: **${userRole.toUpperCase()}** | UID: \`${uid}\``;
                }
                
                updateUIVisibility();
                
            } catch (error) {
                console.error("Profil yÃ¼klenirken hata:", error);
                showModal("VeritabanÄ± HatasÄ±", `Profil yÃ¼klenirken sorun oluÅŸtu: ${error.message}`);
                userRole = "anon"; // Hata durumunda gÃ¼venli moda dÃ¶n
            }
        }

        /**
         * Firestore Ã¼zerinden sohbet geÃ§miÅŸini gerÃ§ek zamanlÄ± dinler.
         */
        function setupChatListener() {
            if (!currentUserId || currentUserId.startsWith("anon")) {
                renderChatHistory([]);
                return;
            }
            
            const chatDocRef = doc(db, getUserDocPath('chat'));

            // Firestore'da dinleyici kurma
            onSnapshot(chatDocRef, (docSnap) => {
                const historyDiv = document.getElementById('chat-history');
                const adminHistoryDiv = document.getElementById('admin-chat-history');
                
                // Ã–nceki yÃ¼kleme mesajÄ±nÄ± kaldÄ±r
                if (historyDiv.querySelector('.h-full')) historyDiv.innerHTML = ''; 

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Gemini API'ye uygun formata dÃ¶nÃ¼ÅŸtÃ¼r
                    const geminiHistory = firestoreToGeminiHistory(data.messages || []);
                    renderChatHistory(geminiHistory);
                    
                    // Admin/Mod gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in (kendisi olduÄŸu durumda)
                    if (userRole === 'admin' || userRole === 'mod') {
                        const selectedUser = document.getElementById('user-id-select').value;
                        if (!selectedUser || selectedUser === currentUserId) {
                             adminHistoryDiv.innerHTML = 'Kendi sohbet geÃ§miÅŸiniz, ana panelde gÃ¶steriliyor.';
                        }
                    }
                    
                } else {
                    renderChatHistory([]); // Belge yoksa boÅŸ gÃ¶ster
                }
            }, (error) => {
                console.error("Sohbet dinlenirken hata:", error);
                showModal("Hata", `Sohbet geÃ§miÅŸi dinlenirken sorun oluÅŸtu: ${error.message}`);
            });
            
            // Sadece Admin/Mod iÃ§in tÃ¼m kullanÄ±cÄ±larÄ± listele
            if (userRole === 'admin' || userRole === 'mod') {
                loadAllUserIds();
            }
        }
        
        /**
         * Firestore'a yeni mesajÄ± kaydeder (Gemini yanÄ±tÄ±ndan sonra Ã§aÄŸrÄ±lÄ±r)
         * @param {Array<Object>} newGeminiHistory 
         */
        async function saveChatHistory(newGeminiHistory) {
             if (!currentUserId || currentUserId.startsWith("anon")) return;

             const chatDocRef = doc(db, getUserDocPath('chat'));
             
             // Gemini formatÄ±nÄ± (role, text) dizisine dÃ¶nÃ¼ÅŸtÃ¼r
             const firestoreMessages = newGeminiHistory.map(msg => [
                 msg.role, 
                 msg.parts[0].text
             ]);
             
             try {
                 await setDoc(chatDocRef, { messages: firestoreMessages }, { merge: true });
             } catch (error) {
                 console.error("Sohbet kaydedilirken hata:", error);
                 showModal("Kaydetme HatasÄ±", `Sohbet geÃ§miÅŸi kaydedilemedi: ${error.message}`);
             }
        }
        
        // =========================================================================
        // KÄ°MLÄ°K DOÄRULAMA (SIMÃœLASYON) VE ROL Ä°ÅLEMLERÄ°
        // =========================================================================
        
        /**
         * SimÃ¼le edilmiÅŸ giriÅŸ/kayÄ±t iÅŸlemi.
         * @param {boolean} isRegister 
         */
        async function handleAuth(isRegister) {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;
            const authMessage = document.getElementById('auth-message');
            authMessage.textContent = '';
            
            if (!email || !password || password.length < 6) {
                authMessage.textContent = "E-posta ve en az 6 karakterli ÅŸifre girin.";
                return;
            }
            
            const newUserId = email.split('@')[0].replace('.', '_');
            const initialRole = (email.endsWith('@example.com') && email.startsWith('admin')) ? 'admin' : 
                                (email.endsWith('@example.com') && email.startsWith('mod')) ? 'mod' : 'user';

            const profileDocRef = doc(db, `artifacts/${APP_ID}/users/${newUserId}/profile/data`);
            
            try {
                // Firebase kimlik doÄŸrulama yerine, Ã¶zel bir "token" ile giriÅŸ simÃ¼le ediyoruz.
                // GerÃ§ek bir uygulamada, Firebase Auth'u kullanmanÄ±z gerekir.
                const customToken = btoa(newUserId); // Basit bir token simÃ¼lasyonu
                await signOut(auth); // Mevcut oturumu kapat
                await signInWithCustomToken(auth, customToken);
                
                if (isRegister) {
                    await setDoc(profileDocRef, { 
                        role: initialRole, 
                        email: email,
                        created_at: serverTimestamp(),
                        system_instruction: DEFAULT_SYSTEM_INSTRUCTION
                    }, { merge: true });
                    authMessage.textContent = "KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapÄ±ldÄ±.";
                } else {
                    // GiriÅŸte rol kontrolÃ¼ yapÄ±ldÄ± (loadUserProfile iÃ§inde)
                    authMessage.textContent = "GiriÅŸ baÅŸarÄ±lÄ±!";
                }
                
            } catch (error) {
                console.error("GiriÅŸ/KayÄ±t hatasÄ±:", error);
                authMessage.textContent = `GiriÅŸ/KayÄ±t baÅŸarÄ±sÄ±z: ${error.message}`;
            }
        }

        document.getElementById('login-btn').addEventListener('click', () => handleAuth(false));
        document.getElementById('register-btn').addEventListener('click', () => handleAuth(true));
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Anonim olarak yeniden giriÅŸ onAuthStateChanged tarafÄ±ndan otomatik olarak yapÄ±lÄ±r
                updateUIVisibility(true);
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", error);
                showModal("Hata", `Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken sorun oluÅŸtu: ${error.message}`);
            }
        });
        
        // =========================================================================
        // MODERATÃ–R/YÃ–NETÄ°CÄ° Ä°ÅLEMLERÄ°
        // =========================================================================
        
        /**
         * Firestore'dan tÃ¼m kullanÄ±cÄ± ID'lerini Ã§eker.
         */
        async function loadAllUserIds() {
            const usersCollectionRef = collection(db, `artifacts/${APP_ID}/users`);
            const selectElement = document.getElementById('user-id-select');
            selectElement.innerHTML = '<option value="">-- KullanÄ±cÄ± SeÃ§ --</option>';

            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                querySnapshot.forEach((doc) => {
                    const uid = doc.id;
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = uid;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                 console.error("KullanÄ±cÄ± ID'leri yÃ¼klenirken hata:", error);
            }
        }
        
        /**
         * SeÃ§ilen kullanÄ±cÄ±nÄ±n sohbet geÃ§miÅŸini gÃ¶rÃ¼ntÃ¼ler.
         */
        document.getElementById('user-id-select').addEventListener('change', async (e) => {
            const selectedUid = e.target.value;
            const adminHistoryDiv = document.getElementById('admin-chat-history');
            adminHistoryDiv.innerHTML = '<div class="text-center text-blue-500">YÃ¼kleniyor...</div>';
            
            if (!selectedUid) {
                adminHistoryDiv.innerHTML = 'LÃ¼tfen bir kullanÄ±cÄ± seÃ§in.';
                return;
            }
            
            if (selectedUid === currentUserId) {
                 adminHistoryDiv.innerHTML = 'Kendi sohbet geÃ§miÅŸiniz, ana panelde gÃ¶steriliyor.';
                 return;
            }
            
            const chatDocRef = doc(db, `artifacts/${APP_ID}/users/${selectedUid}/chat/history`);
            
            try {
                const docSnap = await getDoc(chatDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const firestoreHistory = data.messages || [];
                    const geminiHistory = firestoreToGeminiHistory(firestoreHistory);
                    
                    let htmlContent = '';
                    for (let i = 0; i < geminiHistory.length; i += 2) {
                        const userMsg = geminiHistory[i];
                        const modelMsg = geminiHistory[i + 1];

                        if (userMsg && userMsg.role === 'user') {
                            htmlContent += `<p class="font-bold text-gray-700 mt-2">KullanÄ±cÄ± (${selectedUid}):</p><p class="p-2 bg-gray-100 rounded">${userMsg.parts[0].text}</p>`;
                        }
                        if (modelMsg && modelMsg.role === 'model') {
                            htmlContent += `<p class="font-bold text-blue-700 mt-2">AI AsistanÄ±:</p><p class="p-2 bg-blue-50 rounded">${modelMsg.parts[0].text}</p>`;
                        }
                    }
                    adminHistoryDiv.innerHTML = htmlContent || 'Sohbet geÃ§miÅŸi boÅŸ.';
                } else {
                    adminHistoryDiv.innerHTML = 'SeÃ§ilen kullanÄ±cÄ±nÄ±n sohbet geÃ§miÅŸi bulunamadÄ±.';
                }
            } catch (error) {
                console.error("Admin geÃ§miÅŸ yÃ¼kleme hatasÄ±:", error);
                adminHistoryDiv.innerHTML = `Hata: ${error.message}`;
            }
        });
        
        // =========================================================================
        // SOHBET Ä°ÅLEMLERÄ° VE GEMINI API
        // =========================================================================
        
        /**
         * Sistem talimatÄ±nÄ± gÃ¼nceller ve Firestore'a kaydeder.
         */
        document.getElementById('instruction-update-btn').addEventListener('click', async () => {
            const newInstruction = document.getElementById('instruction-textarea').value.trim();
            const instructionStatus = document.getElementById('instruction-status');
            
            if (!currentUserId || currentUserId.startsWith("anon")) {
                 instructionStatus.textContent = "Anonim kullanÄ±cÄ±lar talimatÄ± kaydedemez.";
                 return;
            }
            
            const profileDocRef = doc(db, `artifacts/${APP_ID}/users/${currentUserId}/profile/data`);
            
            try {
                await setDoc(profileDocRef, { system_instruction: newInstruction }, { merge: true });
                instructionStatus.textContent = "âœ… Talimat baÅŸarÄ±yla kaydedildi!";
            } catch (error) {
                 console.error("Talimat kaydedilirken hata:", error);
                 instructionStatus.textContent = `Hata: ${error.message}`;
            }
        });

        /**
         * Sohbeti temizler (VeritabanÄ±ndan siler).
         */
        document.getElementById('clear-chat-btn').addEventListener('click', async () => {
            if (!currentUserId || currentUserId.startsWith("anon")) {
                showModal("UyarÄ±", "Anonim kullanÄ±cÄ±larÄ±n geÃ§miÅŸi tarayÄ±cÄ±ya kaydedilmez.");
                document.getElementById('chat-history').innerHTML = '<div class="flex justify-center items-center h-full"><span class="text-gray-500">Sohbet geÃ§miÅŸi temizlendi.</span></div>';
                return;
            }
            
            const chatDocRef = doc(db, getUserDocPath('chat'));
            try {
                await deleteDoc(chatDocRef);
                showModal("BaÅŸarÄ±lÄ±", "Sohbet geÃ§miÅŸiniz veritabanÄ±ndan baÅŸarÄ±yla silindi.");
                // onSnapshot otomatik olarak gÃ¼ncelleyecektir
            } catch (error) {
                console.error("Sohbet silinirken hata:", error);
                showModal("Hata", `Sohbet geÃ§miÅŸi silinirken sorun oluÅŸtu: ${error.message}`);
            }
        });

        /**
         * Gemini API Ã§aÄŸrÄ±sÄ±nÄ± gerÃ§ekleÅŸtirir.
         * @param {string} message 
         */
        async function callGemini(message) {
            if (GEMINI_API_KEY === "GEMINI_API_KEY_HERE" || !GEMINI_API_KEY) {
                document.getElementById('api-warning').classList.remove('hidden');
                return "API anahtarÄ± ayarlanmamÄ±ÅŸ. LÃ¼tfen kodda `GEMINI_API_KEY_HERE` deÄŸerini deÄŸiÅŸtirin.";
            }

            const loadingIndicator = document.getElementById('loading-indicator');
            const sendButton = document.getElementById('send-btn');
            
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;

            // 1. Mevcut GeÃ§miÅŸi YÃ¼kle
            let currentHistory = [];
            const chatDocRef = doc(db, getUserDocPath('chat'));
            
            try {
                const docSnap = await getDoc(chatDocRef);
                if (docSnap.exists()) {
                    currentHistory = firestoreToGeminiHistory(docSnap.data().messages || []);
                }
            } catch (error) {
                 // Hata durumunda boÅŸ geÃ§miÅŸle devam et
                 console.warn("GeÃ§miÅŸ yÃ¼klenemedi, sÄ±fÄ±rdan baÅŸlÄ±yor:", error);
            }
            
            // 2. Yeni KullanÄ±cÄ± MesajÄ±nÄ± Ekle
            currentHistory.push({ role: "user", parts: [{ text: message }] });

            const systemInstruction = document.getElementById('instruction-textarea').value.trim();

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: currentHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            const headers = { "Content-Type": "application/json" };
            let responseText = "API'den yanÄ±t alÄ±namadÄ±.";
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API hatasÄ±: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result?.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text;
                    
                    // KaynaklarÄ± Formatla
                    let sources = "";
                    const grounding = candidate.groundingMetadata?.groundingAttributions;
                    if (grounding && grounding.length > 0) {
                        sources = "\n\n**Kaynaklar:**\n";
                        grounding.forEach((attr, index) => {
                            const uri = attr.web?.uri || '#';
                            const title = attr.web?.title || 'Bilinmeyen BaÅŸlÄ±k';
                            sources += `${index + 1}. [${title}](${uri})\n`;
                        });
                    }
                    responseText += sources;
                    
                    // 3. Yeni Model MesajÄ±nÄ± Ekle ve Kaydet
                    currentHistory.push({ role: "model", parts: [{ text: responseText }] });
                    await saveChatHistory(currentHistory); // Dinleyici UI'Ä± gÃ¼ncelleyecek
                    
                } else if (result.promptFeedback?.blockReason) {
                     responseText = `MesajÄ±nÄ±z politikalar nedeniyle engellendi. Neden: ${result.promptFeedback.blockReason}`;
                     showModal("Engelleme", responseText);
                     // Sadece kullanÄ±cÄ± mesajÄ±nÄ± kaydet (opsiyonel)
                     await saveChatHistory(currentHistory);
                } else {
                    responseText = "API'den beklenen formatta yanÄ±t alÄ±namadÄ±. (BoÅŸ yanÄ±t)";
                    showModal("API HatasÄ±", responseText);
                }

            } catch (error) {
                console.error("API isteÄŸi hatasÄ±:", error);
                responseText = `BaÄŸlantÄ±/API hatasÄ±: ${error.message}. Konsolu kontrol edin.`;
                showModal("BaÄŸlantÄ± HatasÄ±", responseText);
            } finally {
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
            }
        }

        /**
         * Sohbet gÃ¶nderme iÅŸleyicisi.
         */
        async function handleSend() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();

            if (!message) return;
            
            // EÄŸer anonim kullanÄ±cÄ± iseniz, sadece mesajÄ± gÃ¶nderin (kaydetmeyin)
            if (currentUserId && currentUserId.startsWith("anon")) {
                 await callGemini(message);
            } else if (currentUserId) {
                 // KayÄ±tlÄ± kullanÄ±cÄ±lar iÃ§in veritabanÄ± kaydÄ± yapÄ±lÄ±r (callGemini iÃ§inde)
                 await callGemini(message);
            } else {
                 showModal("Hata", "KullanÄ±cÄ± durumu belirlenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
                 return;
            }

            userInput.value = '';
        }

        document.getElementById('send-btn').addEventListener('click', handleSend);
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        
        // =========================================================================
        // UI GÃœNCELLEMELERÄ°
        // =========================================================================

        /**
         * KullanÄ±cÄ± rolÃ¼ne ve giriÅŸ durumuna gÃ¶re UI bileÅŸenlerini gÃ¼nceller.
         * @param {boolean} isLogout Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda
         */
        function updateUIVisibility(isLogout = false) {
            const isLoggedIn = !!auth.currentUser && !auth.currentUser.isAnonymous;
            const authSection = document.getElementById('auth-section');
            const logoutSection = document.getElementById('logout-section');
            const adminModSection = document.getElementById('admin-mod-section');
            const userInfo = document.getElementById('user-info');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const apiWarning = document.getElementById('api-warning');
            
            // API AnahtarÄ± KontrolÃ¼
            if (GEMINI_API_KEY === "GEMINI_API_KEY_HERE" || !GEMINI_API_KEY) {
                apiWarning.classList.remove('hidden');
            } else {
                apiWarning.classList.add('hidden');
            }
            
            // Kimlik DoÄŸrulama BÃ¶lÃ¼mleri
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                logoutSection.classList.remove('hidden');
                userInfo.innerHTML = `**Rol:** ${userRole.toUpperCase()}<br>**UID:** \`${currentUserId}\`<br>**E-posta:** ${auth.currentUser.email}`;
            } else {
                authSection.classList.remove('hidden');
                logoutSection.classList.add('hidden');
                userInfo.textContent = '';
            }

            // Chat ArayÃ¼zÃ¼ Durumu
            const canChat = (GEMINI_API_KEY !== "GEMINI_API_KEY_HERE" && !!GEMINI_API_KEY);
            userInput.disabled = !canChat;
            sendBtn.disabled = !canChat;
            
            // Admin/Mod BÃ¶lÃ¼mleri
            if (userRole === 'admin' || userRole === 'mod') {
                adminModSection.classList.remove('hidden');
                loadAllUserIds();
            } else {
                adminModSection.classList.add('hidden');
            }
            
            // Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda, sohbeti temizle
            if (isLogout) {
                document.getElementById('chat-history').innerHTML = '<div class="flex justify-center items-center h-full"><span class="text-gray-500">LÃ¼tfen giriÅŸ yapÄ±n veya anonim olarak devam edin.</span></div>';
            }
        }


        // =========================================================================
        // BAÅLANGIÃ‡
        // =========================================================================
        window.onload = initFirebase;

    </script>
</body>
</html>
