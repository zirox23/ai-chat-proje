<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sohbet Asistanı</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; 
            overflow: hidden;
        }
        #app {
            background-color: white; 
            border: 1px solid #e2e8f0;
            min-height: calc(100vh - 2rem);
        }
        .chat-container {
            height: calc(100vh - 12rem); 
            min-height: 400px;
        }
        .message-box {
            max-width: 80%;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            animation: fadeIn 0.3s ease-out;
        }
        .user-message {
            background-color: #e0f2fe; /* Mavi 50 */
            color: #1e40af; /* Mavi 800 */
            border: 1px solid #bfdbfe; /* Mavi 200 */
            border-bottom-right-radius: 0.5rem;
        }
        .ai-message {
            background-color: #f0fdf4; /* Yeşil 50 */
            color: #166534; /* Yeşil 800 */
            border: 1px solid #dcfce7; /* Yeşil 200 */
            border-bottom-left-radius: 0.5rem;
        }
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .chat-history::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        /* Renkli Link Stili - DAHA VURGULU VE GÖZ ALICI */
        .tech-link {
            display: inline-flex;
            align-items: center;
            font-weight: 700;
            font-size: 0.8rem; 
            padding: 0.4rem 0.8rem; 
            border-radius: 9999px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0.25rem;
            text-decoration: none; /* Alt çizgiyi kaldır */
        }
        .tech-link:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Renklere Özgü Stiller */
        .github-link {
            background-color: #24292e; /* GitHub Siyahı */
            color: #ffffff;
        }
        .gemini-link {
            background-color: #00bcd4; /* Gemini Mavi-Turkuaz */
            color: #ffffff;
        }
        .firebase-link {
            background-color: #FFCA28; /* Firebase Sarı */
            color: #37474F; /* Koyu Gri Metin */
        }
    </style>
</head>
<body class="p-2">

<div id="app" class="max-w-7xl mx-auto rounded-xl shadow-2xl p-6 md:p-8">
    
    <!-- Başlık ve Oturum Butonu -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-200 pb-4">
        <h1 class="text-3xl font-extrabold text-gray-800 flex items-center mb-2 md:mb-0">
            <svg class="w-7 h-7 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M3.636 5.636l.707.707m0 7.07l.707.707m6.364-7.07l-.707.707M12 21V9"></path></svg>
            AI Sohbet Asistanı
        </h1>
        <button id="auth-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm" disabled>
            Oturum Durumu Yükleniyor...
        </button>
    </header>

    <!-- Oturum Bilgisi ve Hata Alanı -->
    <div id="auth-info" class="text-sm p-3 rounded-lg mb-4 flex flex-col md:flex-row items-center justify-between bg-blue-50 border border-blue-200">
        <span id="auth-status" class="font-medium text-blue-800 mb-2 md:mb-0">
            Oturum durumu yükleniyor...
        </span>
        <span id="gemini-status" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold hidden">
            <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Gemini API Bağlantısı OK
        </span>
        <span id="update-info" class="text-xs text-gray-500 ml-0 md:ml-4 mt-2 md:mt-0">
            Son Güncelleme: 02 Kasım 2025, 15:30
        </span>
    </div>

    <!-- Kritik Hata Mesajı -->
    <div id="critical-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden">
        <strong class="font-bold">Kritik Hata:</strong>
        <span id="error-message" class="block sm:inline"></span>
    </div>

    <!-- Ana İçerik: Talimat ve Sohbet Alanları -->
    <div id="main-content" class="flex flex-col md:flex-row gap-6 chat-container">
        
        <!-- AI Talimat Alanı (Kişisel Prompt) -->
        <div class="md:w-1/3 bg-gray-50 p-5 rounded-xl border border-gray-200 flex flex-col shadow-sm">
            <h2 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                AI Talimatı (Sistem Rolü)
            </h2>
            
            <!-- Bu prompt, her kullanıcı için ayrı ayrı Firestore'a kaydedilir (Özel Alan) -->
            <textarea id="ai-system-prompt" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-gray-800 bg-white resize-none placeholder-gray-400 text-sm" placeholder="AI'ın nasıl davranması gerektiğini buraya yazın.">
Sen yardımcı ve kibar bir yapay zeka asistanısısın. Türkçe yazar ve samimi bir tonda konuşursun.
            </textarea>
            
            <button id="save-prompt-btn" class="mt-4 p-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 disabled:bg-gray-300 disabled:text-gray-500" disabled>
                Talimatı Kaydet
            </button>
            <p id="prompt-status" class="mt-2 text-xs text-center text-gray-500">
                Talimat yükleniyor...
            </p>
        </div>

        <!-- Sohbet Alanı -->
        <div class="md:w-2/3 flex flex-col bg-white rounded-xl border border-gray-200 shadow-sm">
            
            <h2 class="text-lg font-bold text-gray-700 p-4 border-b border-gray-200 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path></svg>
                Sohbetiniz (Anonim ve Girişli Kullanıcılar Ortak)
            </h2>

            <!-- Sohbet Geçmişi -->
            <div id="chat-history" class="chat-history flex-1 p-4 md:p-6 overflow-y-auto space-y-4">
                <div class="text-center text-gray-400 italic p-4" id="initial-message">
                    Oturum açılıyor. Lütfen bekleyiniz...
                </div>
            </div>

            <!-- Mesaj Gönderme Formu -->
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                
                <!-- Renkli Teknolojik Linkler BURAYA TAŞINDI -->
                <div class="flex flex-wrap justify-center sm:justify-end mb-3">
                    <span class="text-gray-700 font-medium text-sm mr-4 flex items-center mb-1 sm:mb-0">
                        Teknolojiler:
                    </span>
                    <a href="https://github.com" target="_blank"
                       class="tech-link github-link">
                       GitHub
                    </a>
                    <a href="https://ai.google.dev/gemini-api" target="_blank"
                       class="tech-link gemini-link">
                       Gemini API
                    </a>
                    <a href="https://firebase.google.com" target="_blank"
                       class="tech-link firebase-link">
                       Firebase
                    </a>
                </div>

                <form id="chat-form" class="flex gap-3">
                    <input type="text" id="user-input" placeholder="Mesajınızı buraya yazın..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-gray-800 bg-white placeholder-gray-400" autocomplete="off" disabled>
                    <button type="submit" id="send-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-gray-300 disabled:text-gray-500" disabled>
                        Gönder
                    </button>
                </form>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                    <button type="button" id="clear-chat-btn" class="hover:underline text-red-500 font-medium disabled:text-gray-400 transition duration-150" disabled>
                        Sohbeti Temizle (Yalnızca Sizin Mesajlarınız)
                    </button>
                    <span id="chat-error" class="text-red-500 font-medium hidden"></span>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Eski Footer Alanı Sadece Tarih Bilgisiyle Kaldı -->
    <footer class="text-center text-xs text-gray-500 mt-6 border-t border-gray-200 pt-4 bg-white rounded-b-xl">
        <p class="text-sm font-semibold mb-3">
            <span class="text-red-600">02 Kasım 2025, 15:30'da</span> Güncellendi (Sayfa Altı)
        </p>
    </footer>
</div>


<!-- Oturum Modal Penceresi (Login/Register Pop-up) -->
<div id="auth-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden modal">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h3 class="text-2xl font-bold text-gray-800">Oturum Yönetimi</h3>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold transition duration-150">&times;</button>
        </div>
        
        <!-- Tablar -->
        <div class="flex mb-4">
            <button id="modal-login-tab" class="flex-1 p-3 text-lg font-semibold rounded-l-lg bg-indigo-500 text-white">Giriş Yap</button>
            <button id="modal-register-tab" class="flex-1 p-3 text-lg font-semibold rounded-r-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150">Kayıt Ol</button>
        </div>

        <!-- Giriş Formu -->
        <div id="login-form-content">
            <input type="email" id="login-email" placeholder="E-posta" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
            <input type="password" id="login-password" placeholder="Şifre" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
            <button id="login-btn" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">Giriş Yap</button>
            <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden"></p>
        </div>

        <!-- Kayıt Formu -->
        <div id="register-form-content" class="hidden">
            <input type="email" id="register-email" placeholder="E-posta" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
            <input type="password" id="register-password" placeholder="Şifre (Min 6 karakter)" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
            <input type="password" id="register-password-confirm" placeholder="Şifre Onayı" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">
            <button id="register-btn" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150">Kayıt Ol</button>
            <p id="register-error" class="text-red-500 text-sm mt-3 text-center hidden"></p>
        </div>
    </div>
</div>


<script type="module">
    // Firebase ve Diğer Modül İçe Aktarmaları
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        signOut, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        collection, 
        query, 
        onSnapshot, 
        serverTimestamp, 
        deleteDoc, 
        getDocs, 
        getDoc,
        where 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    // --- GLOBAL AYARLAR ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const apiKey = ""; 

    setLogLevel('debug'); // Firestore ve Auth için detaylı logları aç

    let db, auth, app;
    let userId = null;
    let chatHistory = [];
    let isAILoading = false;
    let isReadyToChat = false; 
    let unsubscribeFromChatHistory = null;
    let isInitialAuthAttempted = false; // İlk oturum açma denemesini takip etmek için

    
    // Uygulama başlatma
    try {
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            document.getElementById('error-message').textContent = 'Firebase yapılandırması eksik. Uygulama çalışmayacaktır.';
            document.getElementById('critical-error').classList.remove('hidden');
        }
    } catch (e) {
        console.error("Firebase başlatma hatası:", e);
        document.getElementById('error-message').textContent = `Firebase başlatma hatası: ${e.message}`;
            document.getElementById('critical-error').classList.remove('hidden');
    }
    
    // Firestore Yol Yardımcıları
    // ORTAK SOHBET YOLU: ANOMİM VE ÜYELERİN HEPSİ BURAYA YAZAR/OKUR (MANDATORY PUBLIC PATH)
    const getChatCollectionRef = () => collection(db, `artifacts/${appId}/public/data/chat_messages`);
    
    // KİŞİSEL AYARLAR YOLU (SADECE GİRİŞ YAPMIŞ KULLANICILARIN PROMPT AYARI)
    const getPromptDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/ai_settings`, 'prompt_settings');
    
    // --- UI ELEMANLARI ---
    const authStatusEl = document.getElementById('auth-status');
    const authBtnEl = document.getElementById('auth-btn');
    const userInputEl = document.getElementById('user-input');
    const sendBtnEl = document.getElementById('send-btn');
    const chatHistoryEl = document.getElementById('chat-history');
    const chatFormEl = document.getElementById('chat-form');
    const chatErrorEl = document.getElementById('chat-error');
    const savePromptBtnEl = document.getElementById('save-prompt-btn');
    const aiSystemPromptEl = document.getElementById('ai-system-prompt');
    const promptStatusEl = document.getElementById('prompt-status');
    const initialMessageEl = document.getElementById('initial-message');
    const clearChatBtnEl = document.getElementById('clear-chat-btn');
    const geminiStatusEl = document.getElementById('gemini-status');
    const criticalErrorEl = document.getElementById('critical-error');
    
    // Modal Elemanları
    const authModalEl = document.getElementById('auth-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalLoginTab = document.getElementById('modal-login-tab');
    const modalRegisterTab = document.getElementById('modal-register-tab');
    const loginFormContent = document.getElementById('login-form-content');
    const registerFormContent = document.getElementById('register-form-content');
    const loginEmailEl = document.getElementById('login-email');
    const loginPasswordEl = document.getElementById('login-password');
    const loginBtnEl = document.getElementById('login-btn');
    const loginErrorEl = document.getElementById('login-error');
    const registerEmailEl = document.getElementById('register-email');
    const registerPasswordEl = document.getElementById('register-password');
    const registerPasswordConfirmEl = document.getElementById('register-password-confirm');
    const registerBtnEl = document.getElementById('register-btn');
    const registerErrorEl = document.getElementById('register-error');


    // --- YARDIMCI FONKSİYONLAR ---

    function displayError(message) {
        criticalErrorEl.classList.remove('hidden');
        document.getElementById('error-message').textContent = message;
        setChatReadyState(false);
    }
    
    function createMessageElement(text, role, uid, currentUserId) {
        const messageDiv = document.createElement('div');
        const isUser = uid === currentUserId; // Kullanıcı kendi mesajı mı
        const roleClass = isUser ? 'user-message rounded-bl-xl' : 'ai-message rounded-br-xl';
        const senderLabel = isUser ? 'Siz' : (role === 'model' ? 'AI Asistanı' : 'Anonim');
        
        messageDiv.className = `message-box p-4 rounded-xl ${roleClass} flex flex-col`;
        
        // Sadece AI mesajlarında tam metni göster, diğer mesajlarda sadece metni göster.
        messageDiv.innerHTML = `
            <div class="font-bold text-xs mb-1 ${isUser ? 'text-indigo-600' : 'text-green-800'}">
                ${senderLabel} - ID: ${uid.substring(0, 8)}
            </div>
            <p class="whitespace-pre-wrap">${text}</p>
        `;

        const container = document.createElement('div');
        container.className = `flex ${isUser ? 'justify-end' : 'justify-start'} w-full`;
        container.appendChild(messageDiv);

        chatHistoryEl.appendChild(container);
    }
    
    function createPendingElement() {
        const container = document.createElement('div');
        container.className = `flex justify-start w-full`;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-box p-4 rounded-xl ai-message rounded-br-xl flex flex-col`;
        messageDiv.innerHTML = `<div class="text-gray-500 italic">AI yanıt bekleniyor...</div>`;
        messageDiv.id = 'pending-ai-response';
        container.appendChild(messageDiv);
        chatHistoryEl.appendChild(container);
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }


    function renderChatHistory(history) {
        chatHistory = history;
        chatHistoryEl.innerHTML = ''; 
        if (history.length === 0) {
            initialMessageEl.textContent = 'Merhaba! Sohbeti başlatmak için bir şeyler yazın. Sohbetiniz herkes tarafından görülecektir.';
            chatHistoryEl.appendChild(initialMessageEl);
            initialMessageEl.classList.remove('hidden');
        } else {
            initialMessageEl.classList.add('hidden');
            history.forEach(msg => createMessageElement(msg.text, msg.role, msg.uid, userId));
        }
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }

    function setChatReadyState(ready) {
        isReadyToChat = ready;
        userInputEl.disabled = !ready || isAILoading;
        clearChatBtnEl.disabled = !ready;
        
        if (ready) {
            userInputEl.placeholder = "Mesajınızı buraya yazın...";
            geminiStatusEl.classList.remove('hidden');
        } else {
            userInputEl.placeholder = "Oturum bekleniyor...";
            geminiStatusEl.classList.add('hidden');
        }
        sendBtnEl.disabled = !ready || isAILoading || userInputEl.value.trim() === '';
    }

    function setLoadingState(isLoading) {
        isAILoading = isLoading;
        setChatReadyState(isReadyToChat); 
        sendBtnEl.textContent = isLoading ? 'AI yanıt veriyor...' : 'Gönder';
    }


    // --- FIREBASE PROMPT OKUMA / YAZMA ---
    // Anonim kullanıcılar prompt kaydedemez/yükleyemez.
    async function loadPrompt() {
        // Anonim kullanıcılar için varsayılan prompt'u kullan
        if (auth.currentUser?.isAnonymous) {
            aiSystemPromptEl.disabled = true;
            savePromptBtnEl.disabled = true;
            promptStatusEl.textContent = 'Anonim kullanıcılar rol tanımı değiştiremez.';
            return;
        }

        aiSystemPromptEl.disabled = false;
        savePromptBtnEl.disabled = false;
        promptStatusEl.textContent = 'Talimat yükleniyor...';
        
        try {
            const docRef = getPromptDocRef(userId);
            const promptDoc = await getDoc(docRef);
            
            if (promptDoc.exists()) {
                const data = promptDoc.data();
                aiSystemPromptEl.value = data.prompt || aiSystemPromptEl.placeholder;
                promptStatusEl.textContent = 'Talimat başarıyla yüklendi.';
            } else {
                // İlk defa giriş yapan üyeler için varsayılan prompt'u kaydet
                await savePrompt(true); 
            }
        } catch (error) {
            console.error("Talimat yükleme hatası:", error);
            promptStatusEl.textContent = 'HATA: Talimat yüklenemedi.';
        }
    }

    async function savePrompt(isInitialSave = false) {
        if (!userId || auth.currentUser.isAnonymous) return;

        if (!isInitialSave) {
            savePromptBtnEl.disabled = true;
            promptStatusEl.textContent = 'Kaydediliyor...';
        }
        try {
            await setDoc(getPromptDocRef(userId), {
                prompt: aiSystemPromptEl.value.trim(),
                timestamp: serverTimestamp()
            });
            promptStatusEl.textContent = isInitialSave ? 'Varsayılan talimat ayarlandı.' : 'Talimat başarıyla kaydedildi!';
        } catch (error) {
            console.error("Talimat kaydetme hatası:", error);
            promptStatusEl.textContent = 'HATA: Talimat kaydedilemedi.';
        } finally {
            if (!isInitialSave) {
                savePromptBtnEl.disabled = false;
            }
        }
    }
    
    // --- SOHBETİ TEMİZLEME (Sadece Kullanıcının Kendi Mesajlarını Siler) ---

    async function clearChat() {
        if (!userId || isAILoading) return;

        // confirm() yerine custom modal kullanılması daha iyidir, ancak mevcut yapıyı koruyorum.
        if (!confirm("SADECE kendi gönderdiğiniz mesajları (veritabanı dahil) silmek istediğinizden emin misiniz?")) {
            return;
        }

        clearChatBtnEl.disabled = true;
        setLoadingState(true);
        chatErrorEl.classList.add('hidden');
        
        try {
            const chatCollectionRef = getChatCollectionRef();
            // Yalnızca mevcut kullanıcı ID'sine sahip mesajları sorgula
            const q = query(chatCollectionRef, where("uid", "==", userId));
            const querySnapshot = await getDocs(q);
            
            for (const doc of querySnapshot.docs) {
                await deleteDoc(doc.ref);
            }
            
            console.log(`Kullanıcı ${userId} için mesajlar başarıyla temizlendi.`);
            
        } catch (error) {
            console.error("Sohbeti temizleme hatası:", error);
            chatErrorEl.textContent = 'Sohbet temizlenirken bir hata oluştu.';
            chatErrorEl.classList.remove('hidden');
        } finally {
            clearChatBtnEl.disabled = false;
            setLoadingState(false);
        }
    }


    function setupChatHistoryListener() {
        if (!userId) return;

        // Sohbetin herkes tarafından okunabilmesi için herkese açık koleksiyonu dinle
        const q = query(getChatCollectionRef(), /*orderBy('timestamp')*/); // orderBy kullanmıyoruz
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const newHistory = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Veri çekildikten sonra istemci tarafında sıralama
            newHistory.sort((a, b) => {
                const aTime = a.timestamp?.toMillis() || a.timestamp || 0;
                const bTime = b.timestamp?.toMillis() || b.timestamp || 0;
                return aTime - bTime;
            });

            renderChatHistory(newHistory);
            
            // İLK VERİ GELDİĞİNDE sohbeti hazır olarak işaretle
            if (!isReadyToChat) {
                setChatReadyState(true);
            }

        }, (error) => {
            console.error("Sohbet geçmişi dinleme hatası:", error);
            chatHistoryEl.innerHTML = `<div class="text-center text-red-500 p-4">HATA: Sohbet geçmişi yüklenemedi.</div>`;
            setChatReadyState(false);
        });

        return unsubscribe; 
    }

    // --- GEMINI API İŞLEMLERİ ---

    // Geri çekilme (exponential backoff) mantığı
    async function fetchWithRetry(url, options, retries = 3) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // API 4xx/5xx hata döndürürse ve son deneme değilse tekrar dene
                    if (i < retries - 1) {
                         // Geri çekilme bekleme süresi: 2^i * 1000 ms
                        const delay = Math.pow(2, i) * 1000; 
                        console.warn(`API çağrısı başarısız (${response.status}). ${delay}ms sonra tekrar deniyor...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    const errorData = await response.json();
                    throw new Error(`API Hatası: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }
                return response;
            } catch (error) {
                if (i === retries - 1) throw error; // Son denemede hata fırlat
            }
        }
    }


    async function generateContent(userQuery) {
        setLoadingState(true);
        chatErrorEl.classList.add('hidden');
        
        createPendingElement(); // Bekleyen yanıt balonu

        const systemPrompt = aiSystemPromptEl.value.trim() || 'Sen kibar ve yardımcı bir yapay zeka asistanısısın.';

        // Yalnızca son 10 mesajı (AI ve Kullanıcı) al
        const contents = chatHistory.slice(-10)
            .filter(msg => msg.role === 'user' || msg.role === 'model') // Yalnızca bu rollerdeki mesajları al
            .map(msg => ({ 
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));

        contents.push({ role: 'user', parts: [{ text: userQuery }] });

        const payload = {
            contents: contents,
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let aiResponseText = "Üzgünüm, yanıt alınırken bir sorun oluştu.";
        let success = false;

        try {
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || aiResponseText;
            success = true;

        } catch (error) {
            console.error("Gemini API çağrısında hata:", error);
            chatErrorEl.textContent = `Mesaj gönderilemedi: ${error.message}`;
            chatErrorEl.classList.remove('hidden');
            aiResponseText = "İletişim hatası. Lütfen konsolu kontrol edin.";
            success = false;
        } finally {
            const pendingEl = document.getElementById('pending-ai-response');
            if (pendingEl) pendingEl.remove();
            
            // API çağrısı başarılı olsun veya olmasın, kullanıcı mesajını kaydet
            await saveUserMessageToDB(userQuery);
            
            // Sadece API çağrısı başarılıysa AI yanıtını kaydet
            if (success) {
                await saveAIMessageToDB(aiResponseText);
            } else {
                 // Eğer AI yanıtı başarısızsa, kullanıcıya bir hata mesajı kaydet
                 await saveAIMessageToDB(aiResponseText, true);
            }
            
            setLoadingState(false);
        }
    }

    // Kullanıcı mesajını kaydetme
    async function saveUserMessageToDB(userText) {
        if (!userId) return;
        const chatCollectionRef = getChatCollectionRef();
        try {
            await addDoc(chatCollectionRef, {
                text: userText,
                role: 'user',
                uid: userId, // Sohbet herkese açık olsa da, mesajın kime ait olduğunu belirtiriz
                timestamp: serverTimestamp()
            });
        } catch (error) {
            console.error("Kullanıcı mesajını kaydederken hata:", error);
        }
    }
    
    // AI mesajını kaydetme
    async function saveAIMessageToDB(aiText, isError = false) {
        if (!userId) return;
        const chatCollectionRef = getChatCollectionRef();
        try {
            await addDoc(chatCollectionRef, {
                text: aiText,
                role: 'model',
                uid: 'gemini-ai-bot', // Sabit AI ID'si
                timestamp: serverTimestamp(),
                error: isError
            });
        } catch (error) {
            console.error("AI mesajını kaydederken hata:", error);
        }
    }

    
    // --- MODAL YÖNETİMİ ---
    function openAuthModal(mode = 'login') {
        authModalEl.classList.remove('hidden');
        if (mode === 'register') {
            showRegisterForm();
        } else {
            showLoginForm();
        }
    }

    function closeAuthModal() {
        authModalEl.classList.add('hidden');
        loginErrorEl.classList.add('hidden');
        registerErrorEl.classList.add('hidden');
        loginEmailEl.value = '';
        loginPasswordEl.value = '';
        registerEmailEl.value = '';
        registerPasswordEl.value = '';
        registerPasswordConfirmEl.value = '';
    }

    function showLoginForm() {
        loginFormContent.classList.remove('hidden');
        registerFormContent.classList.add('hidden');
        modalLoginTab.classList.add('bg-indigo-500', 'text-white');
        modalLoginTab.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        modalRegisterTab.classList.remove('bg-indigo-500', 'text-white');
        modalRegisterTab.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
    }

    function showRegisterForm() {
        loginFormContent.classList.add('hidden');
        registerFormContent.classList.remove('hidden');
        modalRegisterTab.classList.add('bg-indigo-500', 'text-white');
        modalRegisterTab.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        modalLoginTab.classList.remove('bg-indigo-500', 'text-white');
        modalLoginTab.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
    }

    // --- OTURUM YÖNETİMİ ---

    function updateAuthUI(isLoggedIn, userEmail = 'Oturum Kapalı') {
        if (isLoggedIn) {
            authBtnEl.textContent = 'Çıkış Yap';
            authBtnEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            authBtnEl.classList.add('bg-red-500', 'hover:bg-red-600');
            
            const isAnonymous = auth.currentUser.isAnonymous;
            
            authStatusEl.innerHTML = `
                <span class="font-semibold ${isAnonymous ? 'text-orange-700' : 'text-green-700'}">
                    **Oturum:** ${isAnonymous ? 'Anonim' : 'Üye'} 
                </span>
                <span class="text-gray-600">
                    | **Kullanıcı:** ${userEmail} | **ID:** ${userId.substring(0, 8) + '...'}
                </span>
            `;
            console.log("Mevcut Kullanıcı ID:", userId);
        } else {
            authBtnEl.textContent = 'Giriş Yap / Kayıt Ol'; 
            authBtnEl.classList.remove('bg-red-500', 'hover:bg-red-600');
            authBtnEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            authStatusEl.innerHTML = `<span class="font-semibold text-gray-500">Oturum Açık Değil. Lütfen giriş yapın veya anonim olarak kalın.</span>`;
        }
    }

    authBtnEl.addEventListener('click', async () => {
        if (!auth.currentUser) return openAuthModal(); // Auth henüz hazır değilse
        
        // Üye (E-posta/Şifre) veya Özel Token ile giriş yapmış bir kullanıcıysa ÇIKIŞ YAP
        if (!auth.currentUser.isAnonymous) { 
            try {
                await signOut(auth);
                closeAuthModal();
            } catch (error) {
                console.error("Çıkış yapma hatası:", error);
            }
        } else { // Anonim ise modalı aç
            openAuthModal();
        }
    });


    // --- KİMLİK DOĞRULAMA İŞLEMLERİ ---
    
    loginBtnEl.addEventListener('click', async () => {
        loginErrorEl.classList.add('hidden');
        const email = loginEmailEl.value.trim();
        const password = loginPasswordEl.value.trim();
        
        if (!email || !password) {
            loginErrorEl.textContent = "E-posta ve şifre boş bırakılamaz.";
            loginErrorEl.classList.remove('hidden');
            return;
        }

        try {
            loginBtnEl.textContent = "Giriş Yapılıyor...";
            loginBtnEl.disabled = true;
            await signInWithEmailAndPassword(auth, email, password);
            closeAuthModal(); // Başarılıysa modalı kapat
        } catch (error) {
            console.error("Giriş hatası:", error);
            let errorMessage = "Giriş başarısız. Lütfen bilgilerinizi kontrol edin.";
            if (error.code === 'auth/invalid-email') errorMessage = 'Geçersiz e-posta formatı.';
            if (error.code === 'auth/wrong-password') errorMessage = 'E-posta veya şifre hatalı.';
            if (error.code === 'auth/user-not-found') errorMessage = 'Bu e-posta ile kayıtlı kullanıcı bulunamadı.';

            loginErrorEl.textContent = errorMessage;
            loginErrorEl.classList.remove('hidden');
        } finally {
             loginBtnEl.textContent = "Giriş Yap";
             loginBtnEl.disabled = false;
        }
    });

    registerBtnEl.addEventListener('click', async () => {
        registerErrorEl.classList.add('hidden');
        const email = registerEmailEl.value.trim();
        const password = registerPasswordEl.value.trim();
        const confirmPassword = registerPasswordConfirmEl.value.trim();

        if (!email || !password || !confirmPassword) {
            registerErrorEl.textContent = "Tüm alanlar doldurulmalıdır.";
            registerErrorEl.classList.remove('hidden');
            return;
        }
        if (password !== confirmPassword) {
            registerErrorEl.textContent = "Şifreler eşleşmiyor.";
            registerErrorEl.classList.remove('hidden');
            return;
        }
        if (password.length < 6) {
            registerErrorEl.textContent = "Şifre en az 6 karakter olmalıdır.";
            registerErrorEl.classList.remove('hidden');
            return;
        }

        try {
            registerBtnEl.textContent = "Kayıt Olunuyor...";
            registerBtnEl.disabled = true;
            await createUserWithEmailAndPassword(auth, email, password);
            closeAuthModal(); // Başarılıysa modalı kapat
        } catch (error) {
            console.error("Kayıt olma hatası:", error);
            let errorMessage = "Kayıt başarısız. Lütfen tekrar deneyin.";
            if (error.code === 'auth/email-already-in-use') errorMessage = 'Bu e-posta zaten kayıtlı.';
            if (error.code === 'auth/invalid-email') errorMessage = 'Geçersiz e-posta formatı.';
            if (error.code === 'auth/weak-password') errorMessage = 'Şifre en az 6 karakter olmalıdır.';

            registerErrorEl.textContent = errorMessage;
            registerErrorEl.classList.remove('hidden');
        } finally {
             registerBtnEl.textContent = "Kayıt Ol";
             registerBtnEl.disabled = false;
        }
    });


    // --- TEMEL BAŞLATMA VE OTURUM İZLEME ---
    
    onAuthStateChanged(auth, async (user) => {
        if (unsubscribeFromChatHistory) {
            unsubscribeFromChatHistory(); 
            unsubscribeFromChatHistory = null;
        }
        
        // **FIX 2**: Buton metnini hemen güncelle ve kilidini aç
        if (authBtnEl.textContent.includes('Yükleniyor')) {
             authBtnEl.textContent = user ? 'Çıkış Yap' : 'Giriş Yap / Kayıt Ol';
             authBtnEl.disabled = false;
        }

        if (user) {
            // Oturum Açık (Anonim, Üye veya Token ile)
            userId = user.uid;
            const userEmail = user.isAnonymous ? 'Anonim' : user.email || user.uid;
            
            updateAuthUI(true, userEmail);
            setChatReadyState(false); 
            
            // 1. Chat Listener'ı Başlat (Hemen)
            unsubscribeFromChatHistory = setupChatHistoryListener(); // Bu fonksiyon, chat hazır olunca setChatReadyState(true) çağırır.

            // 2. Kullanıcı üye ise (anonim değilse) prompt'u yükle (NON-BLOCKING)
            if (!user.isAnonymous) {
                // **FIX 1**: await kaldırıldı. Sohbet yüklenirken prompt yüklenmesi beklenmez.
                loadPrompt(); 
            } else {
                // Anonim kullanıcılar için prompt alanı devre dışı
                aiSystemPromptEl.disabled = true;
                savePromptBtnEl.disabled = true;
                promptStatusEl.textContent = 'Anonim kullanıcılar rol tanımı değiştiremez.';
            }

            isInitialAuthAttempted = true; // Oturum kontrol edildi

        } else {
            // Oturum Kapalı
            userId = null;
            updateAuthUI(false);
            setChatReadyState(false);
            
            if (!isInitialAuthAttempted) {
                isInitialAuthAttempted = true;
                // TOKEN VEYA ANONİM GİRİŞ ZORLAMASI
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("İlk Oturum Açma Hatası:", error);
                    // Hata durumunda da UI'ın güncellenmesi sağlanmalı
                    updateAuthUI(false, "Kritik Hata: Oturum Açılamadı");
                    displayError("Uygulama başlatılırken kritik oturum açma hatası. Lütfen konsolu kontrol edin.");
                    setChatReadyState(false);
                }
            }
        }
    });

    // --- OLAY DİNLEYİCİLERİ ---
    
    chatFormEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userText = userInputEl.value.trim();

        if (userText && !isAILoading && userId) {
            userInputEl.value = ''; 
            sendBtnEl.disabled = true; 
            await generateContent(userText);
        }
    });

    userInputEl.addEventListener('input', () => {
        sendBtnEl.disabled = !isReadyToChat || isAILoading || userInputEl.value.trim() === '';
    });

    savePromptBtnEl.addEventListener('click', savePrompt);
    clearChatBtnEl.addEventListener('click', clearChat);
    closeModalBtn.addEventListener('click', closeAuthModal);
    modalLoginTab.addEventListener('click', showLoginForm);
    modalRegisterTab.addEventListener('click', showRegisterForm);

</script>
</body>
</html>
